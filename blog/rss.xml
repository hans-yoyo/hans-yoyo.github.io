<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Hans's Site Blog</title>
        <link>https://huhan.tech/blog</link>
        <description>Hans's Site Blog</description>
        <lastBuildDate>Mon, 20 Jun 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-Hans</language>
        <item>
            <title><![CDATA[MySQL大表历史数据清理]]></title>
            <link>https://huhan.tech/blog/mysql-table-clear</link>
            <guid>mysql-table-clear</guid>
            <pubDate>Mon, 20 Jun 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[最近工作中在处理线上几个数据表的清理工作，工作虽然简单，但操作起来注意的地方还是挺多的。现将整个过程进行简单的总结，以便作为日后的参考。]]></description>
            <content:encoded><![CDATA[<p>最近工作中在处理线上几个数据表的清理工作，工作虽然简单，但操作起来注意的地方还是挺多的。现将整个过程进行简单的总结，以便作为日后的参考。</p><p>首先确定下我们清理数据的期望：</p><ul><li>期望清理过程不能对线上业务产生影响，最多只能对线上产生微小、短暂的影响</li><li>期望清理过程最好可复用，整个过程在下次需要清理数据时可以重复使用</li><li>期望能够在监控下进行，如果影响在可控范围内，希望能在任意时刻进行</li></ul><p>对于待清理的历史数据可分为两类，一类是确认没有实际价值的数据，这部分数据可以直接删除，采用定时器的方式定时清理就可以了；另一类的是未来可能有价值的数据，这部分数据一般不会直接删除，而是定时将历史业务数据的归档。</p><p>针对第一类数据，定时清理比较简单，只需要在低峰期定时按条件删除即可</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">delimiter $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT IF NOT EXISTS event_records_interval_clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EVERY 1 DAY STARTS '2022-06-10 01:05:00'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_time BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SET v_time = (SELECT UNIX_TIMESTAMP(DATE_SUB(CURDATE(), INTERVAL 15 DAY)) * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DELETE FROM t_record WHERE create_time &lt; v_time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       END $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在实际工程实践中，可能大部分还是第二类数据，定时归档数据，这里主要需要考虑数据迁移的时间，是否能够用上索引等问题。这部分暂且不表，等后面实际操作了再结合一个案例进行说明。</p><p>当然如果前期已经考虑了数据清理的方案，一切都会比较简单，表不会变得很大，也没有没有在大表中删除数据的需求。但是如果和我们一样，是等到数据量堆积很大了才着手考虑清理，就会遇到在一张在线业务大表中，删除大量历史数据的情况。接下来就对遇到的这种情况进行总结，网上查找的资料，方式主要有两种。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一分批清理">一、分批清理<a class="hash-link" href="#一分批清理" title="标题的直接链接">​</a></h2><p>按一定的查询条件，分批次的删除数据，该方法操作比较简单，但需要注意的地方也比较多</p><p>注意点：</p><ul><li>分批次的查询和删除要控制好数据量、执行耗时，保证每批次耗时不要太长</li><li>进行删除前，预留好足够的存储空间，必要时需要先扩容再清理。在删除后存储空间可能不会降低，还可能会增长，因为实际操作中产生了大量binlog日志。至少预留与删除数据量同等大小的空间</li><li>删除数据后，需要额外对碎片空间进行清理，该操作也比较耗时，需要低峰执行</li></ul><p>实测中，删除 1400w 数据，日志空间增长近10G，与删除数据占用存储空间接近</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">delimiter $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT IF NOT EXISTS event_task_clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EVERY 10 MINUTE STARTS '2022-06-20 22:30:00' ENDS '2022-06-21 03:10:00'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_endId BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_endCreateTime BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_maxEndTime BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SET v_maxEndTime = (SELECT UNIX_TIMESTAMP('2022-05-01 00:00:00') * 1000); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- cost 2.5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SELECT ID, create_time INTO v_endId, v_endCreateTime FROM ttask ORDER BY ID ASC LIMIT 500000,1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IF v_endCreateTime &lt;= v_maxEndTime THEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -- cost 7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DELETE FROM t_preview_convert_task WHERE id &lt; v_endId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        END IF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       END $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二新建临时表分批次导入然后替换">二、新建临时表，分批次导入，然后替换<a class="hash-link" href="#二新建临时表分批次导入然后替换" title="标题的直接链接">​</a></h2><ol><li>拷贝表结构，新建临时表</li><li>导入需要保留的数据，如果数据量大，需要分批次 <code>INSERT</code></li><li>将源表重命名为备份表，临时表命名为原表名</li></ol><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 步骤1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS t_task_tmp like t_task;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 步骤2,需要考虑查询和插入的时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO t_task_tmp SELECT * FROM t_task WHERE id &gt; 6868326044778799105; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 步骤3,重命名，替换原表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RENAME TABLE t_task TO t_task_bak, t_task_tmp TO t_task;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>实际操作中注意以下几点：</p><ul><li>步骤2如果数据过多，需要分批进行</li><li>步骤2和步骤3可能会导致一小部分数据丢失，如果最近数据是热点数据，该方法不适用，或选择在低峰期进行</li><li>如果数据表主键是自增ID，需要更新替换后的表的自增ID</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三案例">三、案例<a class="hash-link" href="#三案例" title="标题的直接链接">​</a></h2><p>我们线上有个任务表 <code>t_task</code>，目前数据量在 <code>2000w</code> ，存储空间在 <code>18G</code> 。计划先将 2 个月以前的数据进行清理，在清理历史数据后再考虑分月归档。</p><p>表的 <code>create_time</code> 字段没有索引，主键 <code>ID</code> 采用雪花算法生成。因为表中数据最近数据为热点数据，所有没有采用方案(二)，使用的是分批删除的方式。</p><p>在实测中发现，分批删除如果根据创建时间做查询删除，耗时不太理想，需要选择在低峰段进行。考虑到我们的数据表主键是趋势递增的，我们可以批量删除前 50w 条数据，直到第50w条记录超出了需要清理的日期，然后再手动将剩余的一小部分数据删除(如果不要求特别精确，其实也可以不删)。实际测试中，采用这种方式每执行一次大约 10s 左右。这样做的好处是耗时短，可以在任意时间段进行，不好的地方是，最后还是需要手动做一次清理。</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">delimiter $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT IF NOT EXISTS event_task_clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EVERY 10 MINUTE STARTS '2022-03-01 00:00:00' ENDS '2022-03-01 06:00:00'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_endId BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_endCreateTime BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_maxEndTime BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SET v_maxEndTime = (SELECT UNIX_TIMESTAMP('2022-01-01 00:00:00') * 1000); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SELECT ID, create_time INTO v_endId, v_endCreateTime FROM t_task ORDER BY ID ASC LIMIT 500000,1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IF v_endCreateTime &lt;= v_maxEndTime THEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DELETE FROM t_task WHERE id &lt; v_endId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        END IF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       END $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四为什么没有采用mysql分区表">四、为什么没有采用MySQL分区表<a class="hash-link" href="#四为什么没有采用mysql分区表" title="标题的直接链接">​</a></h2><ul><li>分区表技术不是用于提升MySQL数据库的性能，而是方便数据的管理。分区表设计不解决性能问题，更多的是解决数据迁移和备份的问题</li><li>分区表，分区键设计不太灵活：<strong>All columns</strong>&nbsp;used in the table's partitioning expression must be part of&nbsp;<strong>every unique key</strong>&nbsp;that the table may have, including any primary key</li><li>分区表达式中，仅可以使用部分函数(<a href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-limitations-functions.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/partitioning-limitations-functions.html</a>)</li><li>有额外的学习成本和潜在的风险</li></ul><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `t_device_online_record_partition`  (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `id` bigint UNSIGNED NOT NULL COMMENT '主键ID',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `device_id` varchar(64) NOT NULL COMMENT '设备ID',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `online` bit NOT NULL COMMENT '是否在线,1/在线,0/离线',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `occur_time` datetime NOT NULL COMMENT '发生时间',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `create_time` bigint UNSIGNED NOT NULL COMMENT '创建时间',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `create_by` varchar(64) NULL COMMENT '创建人',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `update_time` bigint UNSIGNED NULL COMMENT '更新时间',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `update_by` varchar(64) NULL COMMENT '更新人',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `update_version` int UNSIGNED NOT NULL DEFAULT 0 COMMENT '乐观锁',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`id`, `occur_time`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INDEX `idx_device_id_create_time`(`device_id`, `create_time`) USING BTREE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB CHARACTER SET = utf8mb4 COMMENT = '设备上下线记录分区表'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY LIST(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MONTH(occur_time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p01 VALUES IN(1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p02 VALUES IN(2),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p03 VALUES IN(3),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p04 VALUES IN(4),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p05 VALUES IN(5),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p06 VALUES IN(6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p07 VALUES IN(7),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p08 VALUES IN(8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p09 VALUES IN(9),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p10 VALUES IN(10),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p11 VALUES IN(11),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION p12 VALUES IN(12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的示例中，因为想按月分区，于是分区函数中的 <code>occur_time</code> 必须是表中主键的一部分，需要 <code>id</code> 和 <code>occur_time</code> 共同组成复合主键。另外，刚开始是想用bigint类型的 <code>create_time</code> 字段分区，但是没有可利用的函数从时间戳毫秒值获取月份(分区函数中，UNIX_TIMESTAMP()只用作用在TIMESTAMP字段上)，只能单独维护一个datetime类型的字段，或者在入库时就计算好月份。当然也可用使用 <code>RANGE</code> 分区配合 <code>LESS THAN</code>, 计算好固件月份的时间戳，但这样的分区表后面需要到点扩充分区，不是我想要的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文章">参考文章<a class="hash-link" href="#参考文章" title="标题的直接链接">​</a></h2><ol><li>Navicat统计的行数竟然和表实际行数不一致：<a href="https://cloud.tencent.com/developer/article/1909935" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1909935</a></li><li>MySQL数据清理有技巧：<a href="https://cloud.tencent.com/developer/article/1546545" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1546545</a></li><li>Mysql大表数据清理方案：<a href="https://blog.csdn.net/zhaobangyu/article/details/122606850" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/zhaobangyu/article/details/122606850</a></li><li>MySQL CREATE EVENT文档：<a href="https://dev.mysql.com/doc/refman/5.7/en/create-event.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/create-event.html</a></li><li>释放MySQL实例的表空间：<a href="https://help.aliyun.com/document_detail/41720.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/41720.html</a></li><li>MySQL&nbsp;分区表的限制及局限性：<a href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-limitations.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/partitioning-limitations.html</a></li></ol>]]></content:encoded>
            <category>MySQL</category>
        </item>
        <item>
            <title><![CDATA[MySQL定时任务(Event Scheduler)]]></title>
            <link>https://huhan.tech/blog/mysql-event-scheduler</link>
            <guid>mysql-event-scheduler</guid>
            <pubDate>Thu, 09 Jun 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[主要介绍了MySQL Event Scheduler的语法，及一部分示例]]></description>
            <content:encoded><![CDATA[<p>主要介绍了MySQL Event Scheduler的语法，及一部分示例</p><p>基于 MySQL 5.7，官方文档地址：</p><p>CREATE：<a href="https://dev.mysql.com/doc/refman/5.7/en/create-event.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/create-event.html</a></p><p>ALTER EVENT: <a href="https://dev.mysql.com/doc/refman/5.7/en/alter-event.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/alter-event.html</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前置条件">前置条件<a class="hash-link" href="#前置条件" title="标题的直接链接">​</a></h2><p>在创建EVENT之前，需要先确认 <code>Event Scheduler</code> 功能是否开启。<a href="https://dev.mysql.com/doc/refman/5.7/en/events-configuration.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/events-configuration.html</a></p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 查看开启状态 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SHOW GLOBAL VARIABLES like '%event_scheduler%'; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 开启 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET GLOBAL event_scheduler = ON; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 关闭 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET GLOBAL event_scheduler = OFF;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-event">CREATE Event<a class="hash-link" href="#create-event" title="标题的直接链接">​</a></h2><p>语法</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [DEFINER = user]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EVENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [IF NOT EXISTS]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE schedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ON COMPLETION [NOT] PRESERVE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ENABLE | DISABLE | DISABLE ON SLAVE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [COMMENT 'string']</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO event_body;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schedule: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AT timestamp [+ INTERVAL interval] ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | EVERY interval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [STARTS timestamp [+ INTERVAL interval] ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [ENDS timestamp [+ INTERVAL interval] ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interval:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity {YEAR | QUARTER | MONTH | DAY | HOUR | MINUTE |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              WEEK | SECOND | YEAR_MONTH | DAY_HOUR | DAY_MINUTE |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              DAY_SECOND | HOUR_MINUTE | HOUR_SECOND | MINUTE_SECOND}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>DEFINER，定义用户</li><li>schedule，执行计划，有两种方式：<code>ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 1 HOUR</code> 或 <code>EVERY 1 DAY STARTS CURRENT_TIMESTAMP</code></li><li><code>ON COMPLETION [NOT] PRESERVE</code>, 默认EVENT过期后就丢弃(NOT PRESERVE)，可通过 <code>ON COMPLETION PRESERVE</code> 申明过期后仍然保留，一般用于到了时间点，上一个任务还没有执行完成，当前的这个任务是直接丢弃，还是等上个任务执行完成后再执行</li><li><code>[ENABLE | DISABLE | DISABLE ON SLAVE]</code>, 申明从库，一般不申明</li></ul><p>对于DO操作中比较复杂的执行计划，可以通过以下2种方式</p><ul><li><code>DO</code> 中申明 <code>BEGIN</code> 和 <code>END</code></li><li>改成调用储存过程的方式</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="示例">示例<a class="hash-link" href="#示例" title="标题的直接链接">​</a></h2><p><strong>1. 官方示例</strong></p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 示例：每小时更新一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT myevent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 1 HOUR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UPDATE myschema.mytable SET mycol = mycol + 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">delimiter $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EVERY 5 SECOND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v INTEGER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- 这里的 BEGIN END，不清楚是否是笔误</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE CONTINUE HANDLER FOR SQLEXCEPTION BEGIN END;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SET v = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WHILE v &lt; 5 DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          INSERT INTO t1 VALUES (0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          UPDATE t2 SET s1 = s1 + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          SET v = v + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        END WHILE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    END $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT e_call_myproc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AT CURRENT_TIMESTAMP + INTERVAL 1 DAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO CALL myproc(5, 27);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2. 工程实践</strong></p><p>滚动删除历史数据，删除当前时间往前15的历史数据。没有设置 <code>ON COMPLETION PRESERVE</code> 的原因是，如果漏掉一次对事件本身影响不大。</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- CREATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EVENT IF NOT EXISTS records_interval_clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ON SCHEDULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      EVERY 1 DAY STARTS '2021-08-06 01:00:00'        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DECLARE v_time BIGINT(20) DEFAULT 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- 当前日期往前15天</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SET v_time = (SELECT UNIX_TIMESTAMP(DATE_SUB(CURDATE(), INTERVAL 15 DAY)) * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DELETE FROM t_history WHERE create_time &lt; v_time;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       END $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delimiter ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他命令">其他命令<a class="hash-link" href="#其他命令" title="标题的直接链接">​</a></h2><p>查看执行计划：</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM INFORMATION_SCHEMA.events;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>禁用 <code>EVENT</code></p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ALTER EVENT myevent DISABLE;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>DROP</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DROP EVENT [IF EXISTS] event_name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="注意">注意<a class="hash-link" href="#注意" title="标题的直接链接">​</a></h2><ol><li>在定时任务开启前，需要预估下第一次执行时删除的历史数据量，以免因删除数据量过多导致数据库卡死的情况，建议第一次先手动删除历史数据</li><li>删除大表后，数据库的存储空间大小不会改变，需要通过 <code>optimize table</code> 语句释放表空间，后续优化可参考：<a href="https://help.aliyun.com/document_detail/41720.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/41720.html</a> 或 磁盘碎片无锁表空间清理阿里云文档：<a href="https://help.aliyun.com/document_detail/128340.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/128340.html</a></li></ol>]]></content:encoded>
            <category>MySQL</category>
        </item>
        <item>
            <title><![CDATA[SpringBoot配置文件加载优先级]]></title>
            <link>https://huhan.tech/blog/springboot-config-priority</link>
            <guid>springboot-config-priority</guid>
            <pubDate>Sun, 08 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[在开发过程中，不知道有没有这样的经历，项目实际读取的配置信息有时候总是与预期不符，今天就来研究下 SpringBoot 读取配置文件顺序。本文试图对配置的优先级进行总结。]]></description>
            <content:encoded><![CDATA[<p>在开发过程中，不知道有没有这样的经历，项目实际读取的配置信息有时候总是与预期不符，今天就来研究下 <code>SpringBoot</code> 读取配置文件顺序。本文试图对配置的优先级进行总结。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一springboot-配置文件加载优先级">一、SpringBoot 配置文件加载优先级<a class="hash-link" href="#一springboot-配置文件加载优先级" title="标题的直接链接">​</a></h2><p><a href="https://docs.spring.io/spring-boot/docs/2.2.9.RELEASE/reference/htmlsingle/#boot-features-external-config" target="_blank" rel="noopener noreferrer">SpringBoot官方文档</a>说明了加载的顺序如下，越靠前优先级越高。</p><blockquote><p>Spring Boot uses a very particular&nbsp;<code>PropertySource</code>&nbsp;order that is designed to allow sensible overriding of values. Properties are considered in the following order</p></blockquote><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 开发者工具 Devtools 全局配置参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 单元测试上的 [@TestPropertySource](mailto:@TestPropertySource)` 注解指定的参数;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 单元测试上的 [@SpringBootTest](mailto:@SpringBootTest)` 注解指定的参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 命令行指定的参数，如 java -jar springboot.jar --name="xxx"；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 命令行中的 SPRING_APPLICATION_JSON 指定参数, 如 java -Dspring.application.json='{"name":"xxx"}' -jar springboot.jar  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. ServletConfig初始化参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. ServletContext初始化参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8. JNDI参数（如 java:comp/env/spring.application.json）；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9. Java系统参数（来源：System.getProperties()）；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10. 操作系统环境变量参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11. RandomValuePropertySource 随机数，仅匹配：ramdom.*；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12. JAR包外面的配置文件参数（application-{profile}.properties（YAML））  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13. JAR包里面的配置文件参数（application-{profile}.properties（YAML））  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14. JAR包外面的配置文件参数（application.properties（YAML））  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15. JAR包里面的配置文件参数（application.properties（YAML））  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16. @Configuration (mailto:@Configuration)配置文件上 @PropertySource(mailto:@PropertySource) 注解加载的参数；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17. 默认参数（通过 SpringApplication.setDefaultProperties 指定）；  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们只对比常用的几个地方的配置优先级：</p><p>命令行参数 &gt; JAR包外面的 <code>application-{profile}.properties</code> &gt; JAR包内的 <code>application-{profile}.properties</code> &gt; JAR包外的 <code>application.properties</code> &gt; JAR包内的 <code>application.properties</code></p><p>这样可能不太直观，而且有的项目会将 application.properties 文件放在config文件夹内，于是进一步对比了这两个位置的优先级，结果如下</p><p><code>SpringBoot</code> 应用程序在启动时会遵循以下顺序进行加载配置文件  </p><ol><li>类路径下的配置文件  </li><li>类路径内<code>config</code>子目录的配置文件  </li><li>项目根目录下的配置文件  </li><li>项目根目录下<code>config</code>子目录的配置文件  </li></ol><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">. project-sample  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── application.yml （4）  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── src/main/resources  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   │   ├── application.yml （1）  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   │   └── config  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |   │   ├── application.yml （2）  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── application.yml （3）  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">注：src/main/resources下的配置文件在项目编译时，会放在target/classes下  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>启动时加载配置文件顺序：<code>1 -&gt; 2 -&gt; 3 -&gt; 4</code>，优先级 <code>4 &gt; 3 &gt; 2 &gt; 1</code></strong></p><p>注意：  </p><ul><li>如果在<code>IDEA</code>中是多 <code>module</code> 项目，3 和 4 的位置是指的是项目根目录下的位置  </li><li>当 .properties 和 .yml 文件同时存在时，.properties会失效，.yml会起作用。  </li></ul><p><img loading="lazy" src="http://file.huhan.tech/images/202205291130509.png" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二bootstrapyml配置文件">二、bootstrap.yml配置文件<a class="hash-link" href="#二bootstrapyml配置文件" title="标题的直接链接">​</a></h2><p>在 <code>SpringCloud</code> 的项目中，我们常常会碰到另外一个配置文件 <code>bootstrap.yml</code>。这个配置文件主要是用于应用程序上下文的引导阶段，该配置文件的加载是在 <code>application.yml</code> 之前。</p><p>bootstrap.yml 和 application.yml 文件的区别可参考：<a href="https://stackoverflow.com/questions/32997352/what-is-the-difference-between-putting-a-property-on-application-yml-or-bootstra" target="_blank" rel="noopener noreferrer">What is the difference between putting a property on application.yml or bootstrap.yml in spring boot</a></p><p>在 SpringCloud 中有两种上下文，一种是 bootstrap, 另外一种是 application, bootstrap 是应用程序的父上下文。官方的原话是 <a href="https://cloud.spring.io/spring-cloud-commons/multi/multi__spring_cloud_context_application_context_services.html#_the_bootstrap_application_context" target="_blank" rel="noopener noreferrer">A Spring Cloud application operates by creating a&nbsp;“bootstrap”&nbsp;context, which is a parent context for the main application</a>。</p><p><code>bootstrap.yml</code>配置文件的使用场景：</p><ul><li>使用配置中心时，这时需要在bootstrap配置文件中添加连接到配置中心的信息，来加载外部配置中心的配置信息</li><li>一些固定的不能被覆盖的属性</li><li>一些加密/解密的信息</li></ul><p>项目中 <code>bootstrap.yml</code> 示例</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">profiles</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">active</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 远程配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">server-addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">spring.profiles.active</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">file-extension</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 服务发现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">discovery</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">server-addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">spring.profiles.active</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三配置中心的配置">三、配置中心的配置<a class="hash-link" href="#三配置中心的配置" title="标题的直接链接">​</a></h2><p>在 <code>SpringCloud</code> 项目中，我们的配置常由配置中心进行统一管理，这就涉及到本地与远程配置文件的优先级问题。这里只说明遇到过的两种: SpringCloud Config 和 Nacos。</p><ol><li>SpringCloud Config</li></ol><p>SpringCloud Config 中的远程配置，默认是无法被本地覆盖，如果需要本地配置覆盖远程配置，需要在远程做如下配置：</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">allowOverride</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">overrideNone</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">overrideSystemProperties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的说法可以在如下链接中得到验证：
<a href="https://cloud.spring.io/spring-cloud-commons/multi/multi__spring_cloud_context_application_context_services.html#overriding-bootstrap-properties" target="_blank" rel="noopener noreferrer">https://cloud.spring.io/spring-cloud-commons/multi/multi__spring_cloud_context_application_context_services.html#overriding-bootstrap-properties</a></p><ol start="2"><li>Nacos</li></ol><p>Nacos中的远程配置，似乎不支持本地覆盖，在Nacos项目中Issue中得到证实，似乎官方也没有这种打算。值得一提的是，即使通过命令行指定的参数，也不能覆盖远程配置。</p><p>关于该问题的Issue:</p><ul><li><a href="https://github.com/alibaba/nacos/issues/4190" target="_blank" rel="noopener noreferrer">Unable to override datasource</a></li><li><a href="https://github.com/alibaba/nacos/issues/3510" target="_blank" rel="noopener noreferrer">在使用命令行参数(-Dserver.port = 9000)启动被nacos管理的服务客户端时,发现命令行参数没有生效</a></li><li><a href="https://github.com/alibaba/nacos/issues/3981" target="_blank" rel="noopener noreferrer">nacos是否存在类似springcloudconfig的allow-override等本地控制权限参数？或者是否支持这个参数</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四踩过的坑">四、踩过的坑<a class="hash-link" href="#四踩过的坑" title="标题的直接链接">​</a></h2><p>在一次开发过程中，我们希望服务(serviceA)的某些节点的配置与其他节点配置不同，刚开始的想法是在启动命令行加入参数 <code>spring.application.name=serviceB</code>，然后在配置中心 <code>nacos</code>  中复制一份serviceA的配置命名为 service B。但是实际测试中，不能修改 application.name 的值，因为参与到一些业务配置。</p><p>接着我们想直接在命令行中加入区别于其他节点的参数，希望能够覆盖远程的配置，但前面也说过，命令行的配置无法覆盖远程Nacos配置，且Nacos没有提供支持覆盖的开关，所以也没能达到我们预期的结果。</p><p>实际测试的结果，配置优先级：<strong>nacos上的配置 &gt; 命令行配置 &gt; system env &gt; classpath:application.yml &gt; classpath:bootstrap.yml</strong></p><p>最后我们发现nacos支持指定服务配置，以及服务发现的名称，这些配置是在 <code>bootstap.yml</code> 文件中指定，默认值是 <code>spring.application.name</code>。实际测试结果，通过命令行可以覆盖该文件中的配置，这样正好能够满足我们的需求：不修改application.name，又可以使部分节点的配置区别于其他节点。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java -jar ./app.jar --spring.profiles.active</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">local --spring.cloud.nacos.config.name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">serviceB --spring.cloud.nacos.discovery.service</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">serviceB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五参考资料">五、参考资料<a class="hash-link" href="#五参考资料" title="标题的直接链接">​</a></h2><ul><li><a href="https://docs.spring.io/spring-boot/docs/2.2.9.RELEASE/reference/htmlsingle/#boot-features-external-config" target="_blank" rel="noopener noreferrer">SpringBoot Externalized Configuration</a></li><li><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config-en#more-information-about-nacos-config-starter-configurations" target="_blank" rel="noopener noreferrer">Nacos 配置中心，可配置项</a></li><li><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery-en#more-information-about-nacos-discovery-starter-configurations" target="_blank" rel="noopener noreferrer">Nacos注册中心，可配置项</a></li></ul>]]></content:encoded>
            <category>SpringBoot</category>
            <category>config</category>
        </item>
        <item>
            <title><![CDATA[记一次dump文件分析历程]]></title>
            <link>https://huhan.tech/blog/jvm-dump-file-analysis-experience</link>
            <guid>jvm-dump-file-analysis-experience</guid>
            <pubDate>Sat, 12 Mar 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[本文记录了一次排查JVM内存泄露的经历。]]></description>
            <content:encoded><![CDATA[<p>本文记录了一次排查JVM内存泄露的经历。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一背景">一、背景<a class="hash-link" href="#一背景" title="标题的直接链接">​</a></h2><p>今天下午，正酣畅淋漓的搬砖，突然运维同事在群里通知，核心服务某个节点内存异常，服务假死。神经一下子紧张起来，赶紧跑到运维那边观察现象。</p><p>观察的结果是服务内存溢出，该服务是核心服务，分配了5G内存。运维在转存快照后，立刻重启服务后正常。在接下来的一段时间里，另一台服务节点也发生了同样的情况。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二分析过程">二、分析过程<a class="hash-link" href="#二分析过程" title="标题的直接链接">​</a></h2><p>这个服务是另外一个同事负责开发的，本着学习的态度，在拿到运维转存的dump文件后，就准备尝试着分析下问题，由于之前没有类似的经历，于是先在网上查了下一般怎么分析类似的问题。</p><p>首先尝试使用MAT(Memory Analyzer)工具进行分析，下载后就准备载入dump文件，很不幸由于dump文件过大，载入失败了，于是调大了内存大小，尝试再次载入，但此时这个文件不再尝试重新载入，直接提示载入失败。</p><p>先不纠结工具的问题，然后网上说JDK自带的<code>jvisualvm</code>也可以用来分析dump文件, 但也遇到了同样内存不足的问题，再尝试修改<code>jvisualvm</code>的内存限制后, 成功载入了。</p><p>看到的界面是这样的，很明显看到char[]占用了近70%的内存，接近4G，这太不正常了，点进去看对应的实例(加载的非常慢，需要耐心)。</p><p><img loading="lazy" src="http://file.huhan.tech/images/202205291114190.png" class="img_ev3q"></p><p>在实例数界面中看到实例数达到了千万级，大部分都是一些文件的路径字符串信息。在业务中，我们会生成很多临时文件，然后这些临时文件会删除，这里面大部分保存的是这些临时文件路径。</p><p><img loading="lazy" src="http://file.huhan.tech/images/202205291115665.png" class="img_ev3q"></p><p>到这里导致内存泄露的原因似乎找到了，但好像又还不够，是什么原因导致这些临时变量没有被回收呢。</p><p>回到家后，还是想着这个事情，于是又开始研究起来，这个时候想起来可以再用MAT试着分析下，毕竟据说工具很强大。重启了电脑之后，经过漫长的等待，载入成功了(果然重启能解决一切问题)。</p><p>MAT的界面是这样的，里面包含的信息比较多，对于我这个菜鸟来说，确实一下子不知道看哪里。
那就一个个慢慢看吧，Histogram里面的与使用<code>jvisualvm</code>中看到的信息是相同的。</p><p><img loading="lazy" src="http://file.huhan.tech/images/202205291115133.png" class="img_ev3q"></p><p>接下来进入到<code>Dominator Tree</code>视图, 列出当前存活的对象的内存大小，这看起来像是我需要关注的重点。然后查了下这个类 <code>java.io.DeleteOnExitHook</code>  与 内存泄露的相关问题。</p><p><img loading="lazy" src="http://file.huhan.tech/images/202205291116984.png" class="img_ev3q"></p><p>这个问题在下面两个链接中给出了说明，大概意思是在删除文件使用 <code>File.deleteOnExit()</code> 方法时，并不是立刻删除文件，而是将该文件路径维护在类DeleteOnExit的一个LinkedHashSet中，最后在JVM关闭的时候，才会去删除这里面的文件，这个方法不能用于长时间运行的服务。
<a href="https://stackoverflow.com/questions/40119188/memory-leak-on-deleteonexithook" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/40119188/memory-leak-on-deleteonexithook</a>
<a href="https://bugs.openjdk.java.net/browse/JDK-6664633" target="_blank" rel="noopener noreferrer">https://bugs.openjdk.java.net/browse/JDK-6664633</a></p><p>上面的描述，通过源码和JDK文档也都得到了证明。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// java.io.File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Requests that the file or directory denoted by this abstract pathname be deleted when the virtual machine terminates.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void deleteOnExit() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SecurityManager security = System.getSecurityManager();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (security != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        security.checkDelete(path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isInvalid()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DeleteOnExitHook.add(path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// java.io.DeleteOnExitHook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static LinkedHashSet&lt;String&gt; files = new LinkedHashSet&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static synchronized void add(String file) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(files == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DeleteOnExitHook is running. Too late to add a file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException("Shutdown in progress");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    files.add(file);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三结论">三、结论<a class="hash-link" href="#三结论" title="标题的直接链接">​</a></h2><p>问题定位于<code>File.deleteOnExit()</code>方法的调用，导致内存泄漏。调用该方法只会将需要删除文件的路径，维护在类<code>DeleteOnExit</code>的一个LinkedHashSet中，在JVM关闭时，才会去真正执行删除文件操作。这样导致<code>DeleteOnExitHook</code>这个对象越来越大，最终内存溢出。</p><p><code>File.delete()</code>与 <code>File.deleteOnExit()</code> 的区别：
当调用delete()方法时，直接删除文件，不管该文件是否存在，一经调用立即执行
当调用deleteOnExit()方法时，只是相当于对deleteOnExit()作一个声明，当程序运行结束，JVM终止时才真正调用deleteOnExit()方法实现删除操作。</p><p>我写了下面这个测试方法，对比 <code>delete()</code>和<code>deleteOnExit()</code>的区别，现象会比较明显。使用<code>deleteOnExit</code>时是在文件全部创建，JVM关闭的时候，才一个个删除文件，<code>delete</code>会立刻删除文件。(所以这个方法的使用场景是怎样的，我就不太清楚了)</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void loopTest() throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String root = "D:\\C_Temp\\files\\";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File path = new File(root);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!path.exists()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path.mkdirs();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (i &lt; 40000) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        File file = new File(path, "Hello-" + i + ".txt");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file.createNewFile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        file.delete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//            file.deleteOnExit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四收获">四、收获<a class="hash-link" href="#四收获" title="标题的直接链接">​</a></h2><p>本次排查经历最大的收获就是尝试利用工具分析dump文件，以前对这种都是望而却步，感觉很难。但这次带着问题去分析、思考，这样下来也不算过于复杂。有些问题不是问题本身难，是自己把它想得很难。</p><p>下面是本次的一些思考和踩过的坑，以作备忘。</p><p><strong>1. 获取dump文件有两种方法</strong></p><p>1)通过 <code>jmap</code> 工具生成可以生成任意Java进程的dump文件</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 先找到PID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ps</span><span class="token plain"> -ef </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># jmap 转存快照</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jmap -dump:format</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b,file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/dump/test.dump </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PID</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2)通过配置JVM启动参数</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#  当程序出现OutofMemory时，将会在相应的目录下生成一份dump文件，如果不指定选项HeapDumpPath则在当前目录下生成dump文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/dumps</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="http://file.huhan.tech/images/202205291116514.png" class="img_ev3q"></p><p><strong>2. MAT需要JDK11才能运行</strong></p><p>解决办法是，打开MAT的安装目录，有一个配置文件MemoryAnalyzer.ini。打开这个文件，在文件中指定JDK版本即可。新增两行配置：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-vm D:/jdkPath/bin/javaw.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3. 在使用jvisualvm分析大的dump文件时，堆查器使用的内存不足</strong></p><p>修改JAVA_HOME/lib/visualvm/etc/visualvm.conf文件中 visualvm_default_options="-J-client -J-Xms24 -J-Xmx256m"，然后重启jvisualVM即可</p><p><strong>4. MAT修改内存空间</strong></p><p>分析堆转储文件需要消耗很多的堆空间，为了保证分析的效率和性能，在有条件的情况下，建议分配给 MAT 尽可能多的内存资源。两种方式分配内存资源给 MAT：
1）修改启动参数 MemoryAnalyzer.exe -vmargs -Xmx4g
2）编辑文件 MemoryAnalyzer.ini 添加 -vmargs – Xmx4g</p><p>这里也列一个代办项</p><ul><li>学习<code>MAT</code>工具的使用</li></ul><p>参考的一些文章：</p><ul><li>jvisualvm分析：<a href="https://zhuanlan.zhihu.com/p/163774290" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/163774290</a></li><li>MAT定位大对象：<a href="https://www.cnblogs.com/rb2010/p/14741674.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/rb2010/p/14741674.html</a></li><li>MAT详细：<a href="https://blog.csdn.net/Jin_Kwok/article/details/80326088" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/Jin_Kwok/article/details/80326088</a></li><li><a href="https://www.jianshu.com/p/82b25cf8cfde" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/82b25cf8cfde</a></li></ul>]]></content:encoded>
            <category>JVM</category>
        </item>
    </channel>
</rss>