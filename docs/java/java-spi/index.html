<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-java/Java-SPI机制">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Java-SPI机制 | Hans&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://huhan.tech/docs/java/java-spi"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Java-SPI机制 | Hans&#x27;s Site"><meta data-rh="true" name="description" content="转自：https://www.pdai.tech/md/java/advanced/java-advanced-spi.html"><meta data-rh="true" property="og:description" content="转自：https://www.pdai.tech/md/java/advanced/java-advanced-spi.html"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://huhan.tech/docs/java/java-spi"><link data-rh="true" rel="alternate" href="https://huhan.tech/docs/java/java-spi" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://huhan.tech/docs/java/java-spi" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hans&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hans&#39;s Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.f860236f.css">
<link rel="preload" href="/assets/js/runtime~main.a7b9fc3e.js" as="script">
<link rel="preload" href="/assets/js/main.45b8b26f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Hans&#x27;s Site</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">技术手册</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/links">链接</a><a href="https://github.com/hans-yoyo/hans-yoyo.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">知识图谱</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/java笔记">JAVA笔记</a><button aria-label="打开/收起侧边栏菜单「JAVA笔记」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-basic">Java基础语法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-oop">Java面向对象编程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-generic-types">Java泛型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-annotation">Java注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-exception">Java异常</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/java/java-spi">Java-SPI机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/java-reflection">Java反射机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/springboot系列">SpringBoot系列</a><button aria-label="打开/收起侧边栏菜单「SpringBoot系列」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/mysql笔记">MySQL笔记</a><button aria-label="打开/收起侧边栏菜单「MySQL笔记」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/读书笔记">读书笔记</a><button aria-label="打开/收起侧边栏菜单「读书笔记」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/随笔">随笔</a><button aria-label="打开/收起侧边栏菜单「随笔」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/java笔记"><span itemprop="name">JAVA笔记</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Java-SPI机制</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Java-SPI机制</h1></header><p>转自：<a href="https://www.pdai.tech/md/java/advanced/java-advanced-spi.html" target="_blank" rel="noopener noreferrer">https://www.pdai.tech/md/java/advanced/java-advanced-spi.html</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是spi">什么是SPI<a class="hash-link" href="#什么是spi" title="标题的直接链接">​</a></h2><p>Service Provider Interface, 是JDK内置的一种 服务提供发现机制，可以用来启用框架扩展和替换组件。比如java.sql.Driver接口，其他不同厂商可以针对同一接口做出不同的实现，MySQL和PostgreSQL都有不同的实现提供给用户，而Java的SPI机制可以为某个接口寻找服务实现。</p><p>Java中SPI机制主要思想是<strong>将装配的控制权移到程序之外</strong>，在模块化设计中这个机制尤其重要，其核心思想就是 <strong>解耦</strong>。</p><p><strong>SPI整体机制图</strong></p><p><img loading="lazy" src="https://file.huhan.tech/images/202207042300667.jpeg" class="img_ev3q"></p><p>当服务的提供者提供了一种接口的实现之后，需要在classpath下的<code>META-INF/services/</code>目录里创建一个<strong>以服务接口命名</strong>的文件，这个<strong>文件里的内容就是这个接口的具体的实现类</strong>。
当其他的程序需要这个服务的时候，就可以通过查找这个jar包（一般都是以jar包做依赖）的<code>META-INF/services/</code>中的配置文件，配置文件中有接口的具体实现类名，可以根据这个类名进行加载实例化，就可以使用该服务了。<strong>JDK中查找服务的实现的工具类是：<code>java.util.ServiceLoader</code>。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spi-简单示例">SPI 简单示例<a class="hash-link" href="#spi-简单示例" title="标题的直接链接">​</a></h2><p>我们现在需要使用一个内容搜索接口，搜索的实现可能是基于文件系统的搜索，也可能是基于数据库的搜索。</p><ul><li>定义好接口</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Search {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; searchDoc(String keyWork);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>文件搜索实现</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FileSearch implements Search {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; searchDoc(String keyWork) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;文件搜索, keyword = &quot; + keyWork);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>数据库搜索实现</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class DatabaseSearch implements Search {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; searchDoc(String keyWork) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;数据搜索, keyword = &quot; + keyWork);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在resources下新建META-INF/services/目录，然后新建接口全限定名的文件：<code>io.hans.coder.basis.spi.Search</code>，里面加上我们需要用到的实现类</li></ul><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">io.hans.coder.basis.spi.FileSearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#io.hans.coder.basis.spi.DatabaseSearch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://file.huhan.tech/images/202207042301909.png" class="img_ev3q"></p><ul><li>测试类</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServiceLoader&lt;Search&gt; loader = ServiceLoader.load(Search.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator&lt;Search&gt; iterator = loader.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (iterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        iterator.next().searchDoc(&quot;hello spi&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制的应用">SPI机制的应用<a class="hash-link" href="#spi机制的应用" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制---jdbc-drivermanager">SPI机制 - JDBC DriverManager<a class="hash-link" href="#spi机制---jdbc-drivermanager" title="标题的直接链接">​</a></h3><p>在JDBC4.0之前，我们开发有连接数据库的时候，通常会用Class.forName(&quot;com.mysql.jdbc.Driver&quot;)这句先加载数据库相关的驱动，然后再进行获取连接等的操作。<strong>而JDBC4.0之后不需要用Class.forName(&quot;com.mysql.jdbc.Driver&quot;)来加载驱动，直接获取连接就可以了，现在这种方式就是使用了Java的SPI扩展机制来实现</strong>。</p><p><strong>JDBC接口定义</strong></p><p>首先在java中定义了接口<code>java.sql.Driver</code>，并没有具体的实现，具体的实现都是由不同厂商来提供的</p><p><strong>MySQL实现</strong></p><p>在mysql的jar包<code>mysql-connector-java-8.0.15.jar</code>中，可以找到<code>META-INF/services</code>目录，该目录下会有一个名字为<code>java.sql.Driver</code>的文件，文件内容是<code>com.mysql.cj.jdbc.Driver</code>，这里面的内容就是针对Java中定义的接口的实现。</p><p><img loading="lazy" src="https://file.huhan.tech/images/202207042301496.png" class="img_ev3q"></p><p><strong>使用方法</strong></p><p>现在使用SPI扩展来加载具体的驱动，我们在Java中写连接数据库的代码的时候，不需要再使用<code>Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;)</code>来加载驱动了，而是直接使用如下代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">String url = &quot;jdbc:xxxx://xxxx:xxxx/xxxx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection conn = DriverManager.getConnection(url,username,password);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>源码实现</strong></p><p>关于驱动的查找其实都在<code>DriverManager</code>中，<code>DriverManager</code>是Java中的实现，用来获取数据库连接，在<code>DriverManager</code>中有一个静态代码块如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loadInitialDrivers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        println(&quot;JDBC DriverManager initialized&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> private static void loadInitialDrivers() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     String drivers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         drivers = AccessController.doPrivileged(new PrivilegedAction&lt;String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             public String run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 return System.getProperty(&quot;jdbc.drivers&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         drivers = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         public Void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 使用SPI的ServiceLoader来加载接口的实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 while(driversIterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     driversIterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             } catch(Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 // Do nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     println(&quot;DriverManager.initialize: jdbc.drivers = &quot; + drivers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (drivers == null || drivers.equals(&quot;&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     String[] driversList = drivers.split(&quot;:&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     println(&quot;number of Drivers:&quot; + driversList.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     for (String aDriver : driversList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             println(&quot;DriverManager.Initialize: loading &quot; + aDriver);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             Class.forName(aDriver, true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           ClassLoader.getSystemClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             println(&quot;DriverManager.Initialize: load failed: &quot; + ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码主要步骤是：</p><ul><li>从系统变量中获取有关驱动的定义。</li><li>使用SPI来获取驱动的实现。</li><li>遍历使用SPI获取到的具体实现，实例化各个实现类。</li><li>根据第一步获取到的驱动列表来实例化具体实现类。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制---common-logging">SPI机制 - Common-Logging<a class="hash-link" href="#spi机制---common-logging" title="标题的直接链接">​</a></h3><p>common-logging（也称Jakarta Commons Logging，缩写 JCL）是常用的日志库门面</p><p>日志实例是通过LogFactory的getLog(String)方法创建的</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static Log getLog(String name) throws LogConfigurationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getFactory().getInstance(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>LogFatory是一个抽象类，它负责加载具体的日志实现</p><p>抽象类LogFactory加载具体实现的步骤如下：</p><ul><li>从vm系统属性org.apache.commons.logging.LogFactory</li><li>使用SPI服务发现机制，发现org.apache.commons.logging.LogFactory的实现</li><li>查找classpath根目录commons-logging.properties的org.apache.commons.logging.LogFactory属性是否指定factory实现</li><li>使用默认factory实现，org.apache.commons.logging.impl.LogFactoryImpl</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static LogFactory getFactory() throws LogConfigurationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Identify the class loader we will be using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader contextClassLoader = getContextClassLoaderInternal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (contextClassLoader == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // This is an odd enough situation to report about. This</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // output will be a nuisance on JDK1.1, as the system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // classloader is null in that environment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logDiagnostic(&quot;Context classloader is null.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Return any previously registered factory for this class loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LogFactory factory = getCachedFactory(contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factory != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logDiagnostic(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;[LOOKUP] LogFactory implementation requested for the first time for context classloader &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    objectId(contextClassLoader));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logHierarchy(&quot;[LOOKUP] &quot;, contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Load properties file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the properties file exists, then its contents are used as</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // &quot;attributes&quot; on the LogFactory implementation class. One particular</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // property may also control which LogFactory concrete subclass is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // used, but only if other discovery mechanisms fail..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // As the properties file (if it exists) will be used one way or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // another in the end we may as well look for it first.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // classpath根目录下寻找commons-logging.properties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = getConfigurationFile(contextClassLoader, FACTORY_PROPERTIES);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine whether we will be using the thread context class loader to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // load logging classes or not by checking the loaded properties file (if any).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // classpath根目录下commons-logging.properties是否配置use_tccl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader baseClassLoader = contextClassLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (props != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String useTCCLStr = props.getProperty(TCCL_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (useTCCLStr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The Boolean.valueOf(useTCCLStr).booleanValue() formulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // is required for Java 1.2 compatibility.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Boolean.valueOf(useTCCLStr).booleanValue() == false) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Don&#x27;t use current context classloader when locating any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // LogFactory or Log classes, just use the class that loaded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // this abstract class. When this class is deployed in a shared</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // classpath of a container, it means webapps cannot deploy their</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // own logging implementations. It also means that it is up to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // implementation whether to load library-specific config files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // from the TCCL or not.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    baseClassLoader = thisClassLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine which concrete LogFactory subclass to use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // First, try a global system property</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 首先，尝试查找vm系统属性org.apache.commons.logging.LogFactory，其是否指定factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logDiagnostic(&quot;[LOOKUP] Looking for system property [&quot; + FACTORY_PROPERTY +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;] to define the LogFactory subclass to use...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String factoryClass = getSystemProperty(FACTORY_PROPERTY, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (factoryClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logDiagnostic(&quot;[LOOKUP] Creating an instance of LogFactory class &#x27;&quot; + factoryClass +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &quot;&#x27; as specified by system property &quot; + FACTORY_PROPERTY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logDiagnostic(&quot;[LOOKUP] No system property [&quot; + FACTORY_PROPERTY + &quot;] defined.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SecurityException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logDiagnostic(&quot;[LOOKUP] A security exception occurred while trying to create an&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &quot; instance of the custom factory class&quot; + &quot;: [&quot; + trim(e.getMessage()) +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &quot;]. Trying alternative implementations...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RuntimeException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // This is not consistent with the behaviour when a bad LogFactory class is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // specified in a services file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // One possible exception that can occur here is a ClassCastException when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // the specified class wasn&#x27;t castable to this LogFactory type.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logDiagnostic(&quot;[LOOKUP] An exception occurred while trying to create an&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &quot; instance of the custom factory class&quot; + &quot;: [&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              trim(e.getMessage()) +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &quot;] as specified by a system property.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 第二，尝试使用java spi服务发现机制，载META-INF/services下寻找org.apache.commons.logging.LogFactory实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Second, try to find a service by using the JDK1.3 class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // discovery mechanism, which involves putting a file with the name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // of an interface class in the META-INF/services directory, where the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contents of the file is a single line specifying a concrete class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // that implements the desired interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factory == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logDiagnostic(&quot;[LOOKUP] Looking for a resource file of name [&quot; + SERVICE_ID +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              &quot;] to define the LogFactory subclass to use...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                final InputStream is = getResourceAsStream(contextClassLoader, SERVICE_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if( is != null ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // This code is needed by EBCDIC and other strange systems.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // It&#x27;s a fix for bugs reported in xerces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BufferedReader rd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        rd = new BufferedReader(new InputStreamReader(is, &quot;UTF-8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (java.io.UnsupportedEncodingException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        rd = new BufferedReader(new InputStreamReader(is));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String factoryClassName = rd.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rd.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (factoryClassName != null &amp;&amp; ! &quot;&quot;.equals(factoryClassName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            logDiagnostic(&quot;[LOOKUP]  Creating an instance of LogFactory class &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          factoryClassName +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          &quot; as specified by file &#x27;&quot; + SERVICE_ID +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          &quot;&#x27; which was present in the path of the context classloader.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        factory = newFactory(factoryClassName, baseClassLoader, contextClassLoader );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // is == null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        logDiagnostic(&quot;[LOOKUP] No resource file with name &#x27;&quot; + SERVICE_ID + &quot;&#x27; found.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // note: if the specified LogFactory class wasn&#x27;t compatible with LogFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // for some reason, a ClassCastException will be caught here, and attempts will</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // continue to find a compatible class.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logDiagnostic(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;[LOOKUP] A security exception occurred while trying to create an&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot; instance of the custom factory class&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;: [&quot; + trim(ex.getMessage()) +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;]. Trying alternative implementations...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 第三，尝试从classpath根目录下的commons-logging.properties中查找org.apache.commons.logging.LogFactory属性指定的factory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Third try looking into the properties file read earlier (if found)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factory == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (props != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logDiagnostic(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;[LOOKUP] Looking in properties file for entry with key &#x27;&quot; + FACTORY_PROPERTY +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;&#x27; to define the LogFactory subclass to use...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String factoryClass = props.getProperty(FACTORY_PROPERTY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (factoryClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        logDiagnostic(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;[LOOKUP] Properties file specifies LogFactory subclass &#x27;&quot; + factoryClass + &quot;&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    factory = newFactory(factoryClass, baseClassLoader, contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // TODO: think about whether we need to handle exceptions from newFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        logDiagnostic(&quot;[LOOKUP] Properties file has no entry specifying LogFactory subclass.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logDiagnostic(&quot;[LOOKUP] No properties file available to determine&quot; + &quot; LogFactory subclass from..&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 最后，使用后备factory实现，org.apache.commons.logging.impl.LogFactoryImpl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Fourth, try the fallback implementation class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factory == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isDiagnosticsEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logDiagnostic(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;[LOOKUP] Loading the default LogFactory implementation &#x27;&quot; + FACTORY_DEFAULT +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;&#x27; via the same classloader that loaded this LogFactory&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot; class (ie not looking in the context classloader).&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Note: unlike the above code which can try to load custom LogFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // implementations via the TCCL, we don&#x27;t try to load the default LogFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // implementation via the context classloader because:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // * that can cause problems (see comments in newFactory method)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // * no-one should be customising the code of the default class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Yes, we do give up the ability for the child to ship a newer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // version of the LogFactoryImpl class and have it used dynamically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // by an old LogFactory class in the parent, but that isn&#x27;t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // necessarily a good idea anyway.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory = newFactory(FACTORY_DEFAULT, thisClassLoader, contextClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factory != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             * Always cache using context class loader.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cacheFactory(contextClassLoader, factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (props != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Enumeration names = props.propertyNames();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                while (names.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String name = (String) names.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String value = props.getProperty(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    factory.setAttribute(name, value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制---插件体系">SPI机制 - 插件体系<a class="hash-link" href="#spi机制---插件体系" title="标题的直接链接">​</a></h3><p>其实最具spi思想的应该属于插件开发，这里具体说一下eclipse的插件思想。</p><p>Eclipse使用OSGi作为插件系统的基础，动态添加新插件和停止现有插件，以动态的方式管理组件生命周期。
一般来说，插件的文件结构必须在指定目录下包含以下三个文件：</p><ul><li><code>META-INF/MANIFEST.MF</code>: 项目基本配置信息，版本、名称、启动器等</li><li><code>build.properties</code>: 项目的编译配置信息，包括，源代码路径、输出路径</li><li><code>plugin.xml</code>：插件的操作配置信息，包含弹出菜单及点击菜单后对应的操作执行类等</li></ul><p>当eclipse启动时，会遍历plugins文件夹中的目录，扫描每个插件的清单文件<code>MANIFEST.MF</code>，并建立一个内部模型来记录它所找到的每个插件的信息，就实现了动态添加新的插件。
这也意味着是eclipse制定了一系列的规则，像是文件结构、类型、参数等。插件开发者遵循这些规则去开发自己的插件，eclipse并不需要知道插件具体是怎样开发的，只需要在启动的时候根据配置文件解析、加载到系统里就好了，是spi思想的一种体现。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制---spring中的spi机制">SPI机制 - Spring中的SPI机制<a class="hash-link" href="#spi机制---spring中的spi机制" title="标题的直接链接">​</a></h3><p>在springboot的自动装配过程中，最终会加载<code>META-INF/spring.factories</code>文件，而加载的过程是由<code>SpringFactoriesLoader</code>加载的。从CLASSPATH下的每个Jar包中搜寻所有<code>META-INF/spring.factories</code>配置文件，然后将解析properties文件，找到指定名称的配置后返回。需要注意的是，其实这里不仅仅是会去ClassPath路径下查找，会扫描所有路径下的Jar包，只不过这个文件只会在Classpath下的jar包中。</p><p><img loading="lazy" src="https://file.huhan.tech/images/202207042302976.png" class="img_ev3q"></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    protected List&lt;String&gt; getAutoConfigurations() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.autoConfigurations == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 找到所有starter中EnableAutoConfiguration的实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.autoConfigurations = SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.beanClassLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.autoConfigurations;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String factoryClassName = factoryClass.getName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// spring.factories文件的格式为：key=value1,value2,value3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 从所有的jar包中找到META-INF/spring.factories文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 然后从文件中解析出key=factoryClass类名称的所有value值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(@Nullable ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 取得资源文件的URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = (classLoader != null ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = new LinkedMultiValueMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (urls.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URL url = urls.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UrlResource resource = new UrlResource(url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 根据资源文件URL解析properties文件，得到对应的一组@Configuration类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String factoryClassName = ((String) entry.getKey()).trim();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String factoryName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 组装数据，并返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result.add(factoryClassName, factoryName.trim());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache.put(classLoader, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (IOException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;Unable to load factories from location [&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制深入理解">SPI机制深入理解<a class="hash-link" href="#spi机制深入理解" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制通常怎么使用">SPI机制通常怎么使用<a class="hash-link" href="#spi机制通常怎么使用" title="标题的直接链接">​</a></h3><p>流程：</p><ul><li>有关组织或者公司定义标准。</li><li>具体厂商或者框架开发者实现。</li><li>程序猿使用。</li></ul><p><strong>定义标准</strong></p><p>定义标准，就是定义接口。比如接口<code>java.sql.Driver</code></p><p><strong>具体厂商/框架开发者实现</strong></p><p>在<code>META-INF/services</code>目录下定义一个名字为接口全限定名的文件，比如<code>java.sql.Driver</code>文件，文件内容是具体的实现名字，比如<code>me.cxis.sql.MyDriver</code>。
写具体的实现<code>me.cxis.sql.MyDriver</code>，都是对接口Driver的实现</p><p><strong>程序员使用</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//获取迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//遍历</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while(driversIterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driversIterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //可以做具体的业务逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://file.huhan.tech/images/202207042302453.jpeg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi和api的区别">SPI和API的区别<a class="hash-link" href="#spi和api的区别" title="标题的直接链接">​</a></h3><blockquote><p>SPI - “接口”位于“调用方”所在的“包”中</p></blockquote><ul><li>概念上更依赖调用方。</li><li>组织上位于调用方所在的包中。</li><li>实现位于独立的包中。</li><li>常见的例子是：插件模式的插件。</li></ul><blockquote><p>API - “接口”位于“实现方”所在的“包”中</p></blockquote><ul><li>概念上更接近实现方。</li><li>组织上位于实现方所在的包中。</li><li>实现和接口在一个包中。</li></ul><p>参考</p><ul><li><a href="https://stackoverflow.com/questions/2954372/difference-between-spi-and-api?answertab=votes#tab-top" target="_blank" rel="noopener noreferrer">difference-between-spi-and-api(opens new window)</a></li><li><a href="https://www.cnblogs.com/happyframework/archive/2013/09/17/3325560.html" target="_blank" rel="noopener noreferrer">设计原则：小议 SPI 和 API</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制实现原理">SPI机制实现原理<a class="hash-link" href="#spi机制实现原理" title="标题的直接链接">​</a></h3><p><strong>ServiceLoader源码：</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//ServiceLoader实现了Iterable接口，可以遍历所有的服务实现者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ServiceLoader&lt;S&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implements Iterable&lt;S&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //查找配置文件的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String PREFIX = &quot;META-INF/services/&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //表示要被加载的服务的类或接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;S&gt; service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //这个ClassLoader用来定位，加载，实例化服务提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader loader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 访问控制上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AccessControlContext acc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 缓存已经被实例化的服务提供者，按照实例化的顺序存储</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LazyIterator lookupIterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //重新加载，就相当于重新创建ServiceLoader了，用于新的服务提供者安装到正在运行的Java虚拟机中的情况。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void reload() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //清空缓存中所有已实例化的服务提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        providers.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //新建一个迭代器，该迭代器会从头查找和实例化服务提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lookupIterator = new LazyIterator(service, loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //私有构造器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用指定的类加载器和服务创建服务加载器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果没有指定类加载器，使用系统类加载器，就是应用类加载器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ServiceLoader(Class&lt;S&gt; svc, ClassLoader cl) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service = Objects.requireNonNull(svc, &quot;Service interface cannot be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //解析失败处理的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void fail(Class&lt;?&gt; service, String msg, Throwable cause)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ServiceConfigurationError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ServiceConfigurationError(service.getName() + &quot;: &quot; + msg,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            cause);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void fail(Class&lt;?&gt; service, String msg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ServiceConfigurationError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ServiceConfigurationError(service.getName() + &quot;: &quot; + msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void fail(Class&lt;?&gt; service, URL u, int line, String msg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ServiceConfigurationError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fail(service, u + &quot;:&quot; + line + &quot;: &quot; + msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //解析服务提供者配置文件中的一行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //首先去掉注释校验，然后保存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //返回下一行行号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //重复的配置项和已经被实例化的配置项不会被保存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int parseLine(Class&lt;?&gt; service, URL u, BufferedReader r, int lc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          List&lt;String&gt; names)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws IOException, ServiceConfigurationError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //读取一行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ln = r.readLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ln == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //#号代表注释行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int ci = ln.indexOf(&#x27;#&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ci &gt;= 0) ln = ln.substring(0, ci);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ln = ln.trim();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int n = ln.length();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (n != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((ln.indexOf(&#x27; &#x27;) &gt;= 0) || (ln.indexOf(&#x27;\t&#x27;) &gt;= 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fail(service, u, lc, &quot;Illegal configuration-file syntax&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int cp = ln.codePointAt(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!Character.isJavaIdentifierStart(cp))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fail(service, u, lc, &quot;Illegal provider-class name: &quot; + ln);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cp = ln.codePointAt(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != &#x27;.&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fail(service, u, lc, &quot;Illegal provider-class name: &quot; + ln);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!providers.containsKey(ln) &amp;&amp; !names.contains(ln))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                names.add(ln);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return lc + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //解析配置文件，解析指定的url配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用parseLine方法进行解析，未被实例化的服务提供者会被保存到缓存中去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Iterator&lt;String&gt; parse(Class&lt;?&gt; service, URL u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ServiceConfigurationError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InputStream in = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BufferedReader r = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            in = u.openStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            r = new BufferedReader(new InputStreamReader(in, &quot;utf-8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int lc = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while ((lc = parseLine(service, u, r, lc, names)) &gt;= 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return names.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //服务提供者查找的迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class LazyIterator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        implements Iterator&lt;S&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;S&gt; service;//服务提供者接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader loader;//类加载器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; configs = null;//保存实现类的url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Iterator&lt;String&gt; pending = null;//保存实现类的全名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String nextName = null;//迭代器中下一个实现类的全名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private LazyIterator(Class&lt;S&gt; service, ClassLoader loader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.service = service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.loader = loader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean hasNextService() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nextName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (configs == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String fullName = PREFIX + service.getName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (loader == null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configs = ClassLoader.getSystemResources(fullName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configs = loader.getResources(fullName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while ((pending == null) || !pending.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!configs.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pending = parse(service, configs.nextElement());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nextName = pending.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private S nextService() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!hasNextService())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new NoSuchElementException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String cn = nextName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nextName = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Class&lt;?&gt; c = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c = Class.forName(cn, false, loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!service.isAssignableFrom(c)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fail(service, &quot;Provider &quot; + cn  + &quot; not a subtype&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                S p = service.cast(c.newInstance());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                providers.put(cn, p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return p;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean hasNext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (acc == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return hasNextService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                PrivilegedAction&lt;Boolean&gt; action = new PrivilegedAction&lt;Boolean&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public Boolean run() { return hasNextService(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return AccessController.doPrivileged(action, acc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public S next() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (acc == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return nextService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                PrivilegedAction&lt;S&gt; action = new PrivilegedAction&lt;S&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    public S run() { return nextService(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return AccessController.doPrivileged(action, acc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void remove() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new UnsupportedOperationException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //返回遍历服务提供者的迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //以懒加载的方式加载可用的服务提供者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //懒加载的实现是：解析配置文件和实例化服务提供者的工作由迭代器本身完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Iterator&lt;S&gt; iterator() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Iterator&lt;S&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //按照实例化顺序返回已经缓存的服务提供者实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = providers.entrySet().iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean hasNext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (knownProviders.hasNext())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return lookupIterator.hasNext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public S next() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (knownProviders.hasNext())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return knownProviders.next().getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return lookupIterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void remove() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new UnsupportedOperationException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //为指定的服务使用指定的类加载器来创建一个ServiceLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            ClassLoader loader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ServiceLoader&lt;&gt;(service, loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用线程上下文的类加载器来创建ServiceLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ServiceLoader.load(service, cl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用扩展类加载器为指定的服务创建ServiceLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //只能找到并加载已经安装到当前Java虚拟机中的服务提供者，应用程序类路径中的服务提供者将被忽略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static &lt;S&gt; ServiceLoader&lt;S&gt; loadInstalled(Class&lt;S&gt; service) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader prev = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (cl != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prev = cl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cl = cl.getParent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ServiceLoader.load(service, prev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;java.util.ServiceLoader[&quot; + service.getName() + &quot;]&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>首先</strong>，ServiceLoader实现了<code>Iterable</code>接口，所以它有迭代器的属性，这里主要都是实现了迭代器的<code>hasNext</code>和<code>next</code>方法。这里主要都是调用的<code>lookupIterator</code>的相应<code>hasNext</code>和<code>next</code>方法，<code>lookupIterator</code>是懒加载迭代器。</p><p><strong>其次</strong>，<code>LazyIterator</code>中的<code>hasNext</code>方法，静态变量PREFIX就是<code>”META-INF/services/”</code>目录，这也就是为什么需要在<code>classpath</code>下的<code>META-INF/services/</code>目录里创建一个以服务接口命名的文件。</p><p><strong>最后</strong>，通过反射方法<code>Class.forName()</code>加载类对象，并用<code>newInstance</code>方法将类实例化，并把实例化后的类缓存到<code>providers</code>对象中，(<code>LinkedHashMap&lt;String,S&gt;</code>类型）然后返回实例对象。
所以我们可以看到<code>ServiceLoader</code>不是实例化以后，就去读取配置文件中的具体实现，并进行实例化。而是等到使用迭代器去遍历的时候，才会加载对应的配置文件去解析，调用<code>hasNext</code>方法的时候会去加载配置文件进行解析，调用<code>next</code>方法的时候进行实例化并缓存。
所有的配置文件只会加载一次，服务提供者也只会被实例化一次，重新加载配置文件可使用<code>reload</code>方法</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spi机制的缺陷">SPI机制的缺陷<a class="hash-link" href="#spi机制的缺陷" title="标题的直接链接">​</a></h3><ul><li><p>不能按需加载，需要遍历所有的实现，并实例化，然后在循环中才能找到我们需要的实现。如果不想用某些实现类，或者某些类实例化很耗时，它也被载入并实例化了，这就造成了浪费。</p></li><li><p>获取某个实现类的方式不够灵活，只能通过 Iterator 形式获取，不能根据某个参数来获取对应的实现类。</p></li><li><p>多个并发多线程使用 ServiceLoader 类的实例是不安全的</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/java/java-exception"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Java异常</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/java/java-reflection"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Java反射机制</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是spi" class="table-of-contents__link toc-highlight">什么是SPI</a></li><li><a href="#spi-简单示例" class="table-of-contents__link toc-highlight">SPI 简单示例</a></li><li><a href="#spi机制的应用" class="table-of-contents__link toc-highlight">SPI机制的应用</a><ul><li><a href="#spi机制---jdbc-drivermanager" class="table-of-contents__link toc-highlight">SPI机制 - JDBC DriverManager</a></li><li><a href="#spi机制---common-logging" class="table-of-contents__link toc-highlight">SPI机制 - Common-Logging</a></li><li><a href="#spi机制---插件体系" class="table-of-contents__link toc-highlight">SPI机制 - 插件体系</a></li><li><a href="#spi机制---spring中的spi机制" class="table-of-contents__link toc-highlight">SPI机制 - Spring中的SPI机制</a></li></ul></li><li><a href="#spi机制深入理解" class="table-of-contents__link toc-highlight">SPI机制深入理解</a><ul><li><a href="#spi机制通常怎么使用" class="table-of-contents__link toc-highlight">SPI机制通常怎么使用</a></li><li><a href="#spi和api的区别" class="table-of-contents__link toc-highlight">SPI和API的区别</a></li><li><a href="#spi机制实现原理" class="table-of-contents__link toc-highlight">SPI机制实现原理</a></li><li><a href="#spi机制的缺陷" class="table-of-contents__link toc-highlight">SPI机制的缺陷</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Hans | <a href="https://beian.miit.gov.cn/">苏ICP备2021046511号</a> | Built with <a href="https://docusaurus.io/zh-CN/">Docusaurus</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.a7b9fc3e.js"></script>
<script src="/assets/js/main.45b8b26f.js"></script>
</body>
</html>