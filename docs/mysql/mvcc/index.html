<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-mysql/MySQL MVCC 多版本并发控制原理">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">MySQL MVCC 多版本并发控制原理 | HuHan 的个人网站</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://huhan.tech/docs/mysql/mvcc"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="MySQL MVCC 多版本并发控制原理 | HuHan 的个人网站"><meta data-rh="true" name="description" content="MySQL MVCC 多版本并发控制原理"><meta data-rh="true" property="og:description" content="MySQL MVCC 多版本并发控制原理"><meta data-rh="true" name="keywords" content="MySQL"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://huhan.tech/docs/mysql/mvcc"><link data-rh="true" rel="alternate" href="https://huhan.tech/docs/mysql/mvcc" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://huhan.tech/docs/mysql/mvcc" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="HuHan 的个人网站 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="HuHan 的个人网站 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8fa9589d.css">
<link rel="preload" href="/assets/js/runtime~main.a5c98095.js" as="script">
<link rel="preload" href="/assets/js/main.e7217a4b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">学习笔记</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">开发手册</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/wiki/programming-language">程序设计语言</a></li><li><a class="dropdown__link" href="/wiki/spring">Spring</a></li><li><a class="dropdown__link" href="/wiki/database">数据库系统</a></li><li><a class="dropdown__link" href="/wiki/datastructures-algorithms">数据结构与算法</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/life">👩‍👩‍👦 生活</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/links">资源</a><a href="https://github.com/hans-yoyo/hans-yoyo.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">本站说明</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/java">JAVA</a><button aria-label="打开/收起侧边栏菜单「JAVA」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/mysql">MySQL</a><button aria-label="打开/收起侧边栏菜单「MySQL」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/syntax-operate">MySQL语法基础-操作篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/syntax-admin">MySQL语法基础-管理篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/date-types">MySQL数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/functions-and-operators">运算符和常用函数</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/storage-engines">MySQL存储引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/sql-indexes">MySQL 索引</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/sql-execute-procedure">一条SQL的执行过程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/innodb-isolation">InnoDB 存储引擎的事务隔离特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/mysql/mvcc">MySQL MVCC 多版本并发控制原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/explain-cmd">EXPLAIN 命令详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/数据库索引失效的几种场景">数据库索引失效的几种场景</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/sql-optimize">SQL优化的技巧</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql/event-scheduler">MySQL定时任务(Event Scheduler)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/服务器运维">服务器运维</a><button aria-label="打开/收起侧边栏菜单「服务器运维」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/spring">Spring</a><button aria-label="打开/收起侧边栏菜单「Spring」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/框架和中间件">框架和中间件</a><button aria-label="打开/收起侧边栏菜单「框架和中间件」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/redis">Redis</a><button aria-label="打开/收起侧边栏菜单「Redis」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/开发工具">开发工具</a><button aria-label="打开/收起侧边栏菜单「开发工具」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>MySQL MVCC 多版本并发控制原理</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-mvcc">什么是 MVCC<a class="hash-link" href="#什么是-mvcc" title="标题的直接链接">​</a></h2><blockquote><p><strong><code>MVCC</code></strong>，全称 <code>Multi-Version Concurrency Control</code> ，即多版本并发控制。MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存。</p></blockquote><p>MVCC在MySQL InnoDB中的实现主要是为了 <strong>提高数据库并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读</strong>。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-当前读-和-快照读">什么是 当前读 和 快照读<a class="hash-link" href="#什么是-当前读-和-快照读" title="标题的直接链接">​</a></h3><p>在学习MVCC多版本并发控制之前，我们必须先了解一下，什么是MySQL InnoDB下的当前读和快照读?</p><ul><li><strong>当前读</strong>：像 <code>select lock in share mode</code>(共享锁), <code>select for update</code> ; <code>update</code>, <code>insert</code> ,<code>delete</code> (排他锁)这些操作都是一种当前读，为什么叫当前读？就是它读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</li><li><strong>快照读</strong>：像不加锁的select操作就是快照读，即不加锁的非阻塞读；快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读；之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于多版本并发控制，即MVCC,可以认为MVCC是行锁的一个变种，但它在很多情况下，避免了加锁操作，降低了开销；既然是基于多版本，即快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本</li></ul><p><strong>说白了MVCC就是为了实现读-写冲突不加锁，而这个读指的就是快照读, 而非当前读，当前读实际上是一种加锁的操作，是悲观锁的实现</strong></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="当前读快照读和mvcc的关系">当前读，快照读和MVCC的关系<a class="hash-link" href="#当前读快照读和mvcc的关系" title="标题的直接链接">​</a></h3><ul><li>MVCC 多版本并发控制是 <strong>「维持一个数据的多个版本，使得读写操作没有冲突」</strong> 的概念，只是一个抽象概念，并非实现</li><li>因为 MVCC 只是一个抽象概念，要实现这么一个概念，MySQL 就需要提供具体的功能去实现它，<strong>「快照读就是 MySQL 实现 MVCC 理想模型的其中一个非阻塞读功能」</strong>。而相对而言，当前读就是悲观锁的具体功能实现</li><li>要说的再细致一些，快照读本身也是一个抽象概念，再深入研究。MVCC 模型在 MySQL 中的具体实现则是由 <strong>3 个隐式字段，undo 日志 ， Read View</strong> 等去完成的，具体可以看下面的 MVCC 实现原理</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mvcc-能解决什么问题好处是">MVCC 能解决什么问题，好处是？<a class="hash-link" href="#mvcc-能解决什么问题好处是" title="标题的直接链接">​</a></h3><p><strong>数据库并发场景有三种，分别为：</strong></p><ul><li>读-读：不存在任何问题，也不需要并发控制</li><li>读-写：有线程安全问题，可能会造成事务隔离性问题，可能遇到脏读，幻读，不可重复读</li><li>写-写：有线程安全问题，可能会存在更新丢失问题，比如第一类更新丢失，第二类更新丢失</li></ul><p><strong>MVCC 带来的好处是？</strong></p><p>多版本并发控制（MVCC）是一种用来解决读-写冲突的无锁并发控制，也就是为事务分配单向增长的时间戳，为每个修改保存一个版本，版本与事务时间戳关联，读操作只读该事务开始前的数据库的快照。 所以 MVCC 可以为数据库解决以下问题</p><ul><li>在并发读写数据库时，可以做到在读操作时不用阻塞写操作，写操作也不用阻塞读操作，提高了数据库并发读写的性能</li><li>同时还可以解决脏读，幻读，不可重复读等事务隔离问题，但不能解决更新丢失问题</li></ul><p><strong>小结一下：</strong> 简而言之，MVCC 就是因为大佬们，不满意只让数据库采用悲观锁这样性能不佳的形式去解决读-写冲突问题，而提出的解决方案，所以在数据库中，因为有了 MVCC，所以我们可以形成两个组合：</p><ol><li>MVCC + 悲观锁</li></ol><p>MVCC解决读写冲突，悲观锁解决写写冲突</p><ol start="2"><li>MVCC + 乐观锁</li></ol><p>MVCC 解决读写冲突，乐观锁解决写写冲突</p><p>这种组合的方式就可以最大程度的提高数据库并发性能，并解决读写冲突，和写写冲突导致的问题</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mvcc-实现原理">MVCC 实现原理<a class="hash-link" href="#mvcc-实现原理" title="标题的直接链接">​</a></h2><p>MVCC 的目的就是多版本并发控制，在数据库中的实现，就是为了解决 <code>读写冲突</code>，它的实现原理主要是依赖记录中的 <strong><code>3个隐式字段</code></strong>，<strong><code>undo日志</code></strong> ， <strong><code>Read View</code></strong> 来实现的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="隐式字段">隐式字段<a class="hash-link" href="#隐式字段" title="标题的直接链接">​</a></h3><p>每行记录除了我们自定义的字段外，还有数据库隐式定义的 <code>DB_TRX_ID</code>, <code>DB_ROLL_PTR</code>, <code>DB_ROW_ID</code> 等字段</p><p><code>DB_TRX_ID</code>
6 byte，最近修改(修改/插入)事务 ID：记录创建这条记录/最后一次修改该记录的事务 ID</p><p><code>DB_ROLL_PTR</code>
7 byte，回滚指针，指向这条记录的上一个版本（存储于 rollback segment 里）\</p><p><code>DB_ROW_ID</code>
6 byte，隐含的自增 ID（隐藏主键），如果数据表没有主键，InnoDB 会自动以DB_ROW_ID产生一个聚簇索引</p><p>实际还有一个删除 flag 隐藏字段, 既记录被更新或删除并不代表真的删除，而是删除 flag 变了</p><p><img loading="lazy" src="/assets/images/20230415232430-f2a5f671e8dfbc0e9b68ce62dc6ebf9f.png" width="927" height="206" class="img_ev3q"></p><p>如上图，<code>DB_ROW_ID</code> 是数据库默认为该行记录生成的唯一隐式主键，<code>DB_TRX_ID</code> 是当前操作该记录的事务 ID ,而 <code>DB_ROLL_PTR</code> 是一个回滚指针，用于配合 undo日志，指向上一个旧版本。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="undo日志">undo日志<a class="hash-link" href="#undo日志" title="标题的直接链接">​</a></h3><p>undo log 主要分为两种：</p><p><strong>1、insert undo log</strong>
代表事务在 insert 新记录时产生的 undo log, 只在事务回滚时需要，并且在事务提交后可以被立即丢弃</p><p><strong>2、update undo log</strong>
事务在进行 update 或 delete 时产生的 undo log ; 不仅在事务回滚时需要，在快照读时也需要；所以不能随便删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被 purge 线程统一清除</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>purge</div><div class="admonitionContent_S0QG"><ul><li><p>从前面的分析可以看出，为了实现 InnoDB 的 MVCC 机制，更新或者删除操作都只是设置一下老记录的 deleted_bit ，并不真正将过时的记录删除。</p></li><li><p>为了节省磁盘空间，InnoDB 有专门的 purge 线程来清理 deleted_bit 为 true 的记录。为了不影响 MVCC 的正常工作，purge 线程自己也维护了一个read view（这个 read view 相当于系统中最老活跃事务的 read view ）;如果某个记录的 deleted_bit 为 true ，并且 DB_TRX_ID 相对于 purge 线程的 read view 可见，那么这条记录一定是可以被安全清除的。</p></li></ul></div></div><p>对 MVCC 有帮助的实质是 <code>update undo log</code> ，<code>undo log</code> 实际上就是存在 <code>rollback segment</code> 中旧记录链，<strong>它的执行流程如下：</strong></p><p><strong>一、 比如一个有个事务插入 persion 表插入了一条新记录，记录如下，<code>name</code> 为 Jerry , <code>age</code> 为 24 岁，<code>隐式主键</code>是 1，<code>事务 ID</code> 和<code>回滚指针</code>，我们假设为 NULL</strong></p><p><img loading="lazy" src="data:image/png;base64,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" width="833" height="168" class="img_ev3q"></p><p><strong>二、 现在来了一个事务 1 对该记录的 <code>name</code> 做出了修改，改为 <code>Tom</code></strong></p><ul><li>在事务 1 修改该行(记录)数据时，数据库会先对该行加排他锁</li><li>然后把该行数据拷贝到 undo log 中，作为旧记录，既在 undo log 中有当前行的拷贝副本</li><li>拷贝完毕后，修改该行name为Tom，并且修改隐藏字段的事务 ID 为当前事务 1 的 ID, 我们默认从 1 开始，之后递增，回滚指针指向拷贝到 undo log 的副本记录，既表示我的上一个版本就是它</li><li>事务提交后，释放锁</li></ul><p><img loading="lazy" src="/assets/images/20230415232901-8849d846aa886ab870eba81313e596f6.png" width="843" height="361" class="img_ev3q"></p><p><strong>三、又来了个<code>事务 2</code> 修改 <code>person 表</code>的同一个记录，将<code>age</code>修改为 30 岁</strong></p><ul><li>在事务2修改该行数据时，数据库也先为该行加锁</li><li>然后把该行数据拷贝到 undo log 中，作为旧记录，发现该行记录已经有 undo log 了，那么最新的旧数据作为链表的表头，插在该行记录的 undo log 最前面</li><li>修改该行 age 为 30 岁，并且修改隐藏字段的事务 ID 为当前事务 2 的 ID, 那就是 2 ，回滚指针指向刚刚拷贝到 undo log 的副本记录</li><li>事务提交，释放锁</li></ul><p><img loading="lazy" src="/assets/images/20230415233008-4e74552143a36784f11bab7af5fa439a.png" width="838" height="513" class="img_ev3q"></p><p>从上面，我们就可以看出，不同事务或者相同事务的对同一记录的修改，会导致该记录的undo log成为一条记录版本线性表，既链表，undo log 的链首就是最新的旧记录，链尾就是最早的旧记录（当然就像之前说的该 undo log 的节点可能是会 purge 线程清除掉，向图中的第一条 insert undo log，其实在事务提交之后可能就被删除丢失了，不过这里为了演示，所以还放在这里）</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="read-view">Read View<a class="hash-link" href="#read-view" title="标题的直接链接">​</a></h3><p>什么是 Read View，说白了 Read View 就是事务进行 <code>快照读</code> 操作的时候生产的 <code>读视图 (Read View)</code>，在该事务执行的快照读的那一刻，会生成数据库系统当前的一个快照，记录并维护系统当前活跃事务的 ID (<strong>当每个事务开启时，都会被分配一个 ID , 这个 ID 是递增的，所以最新的事务，ID 值越大</strong>)</p><p>所以我们知道 Read View 主要是用来做 <code>可见性</code> 判断的, 即当我们 <strong>某个事务执行快照读的时候，对该记录创建一个 Read View 读视图</strong>，把它比作条件用来判断当前事务能够看到哪个版本的数据，既<strong>可能是当前最新的数据，也有可能是该行记录的undo log里面的某个版本的数据</strong>。</p><p>Read View遵循一个可见性算法，主要是将要被修改的数据的最新记录中的 <code>DB_TRX_ID</code>（即当前事务 ID ）取出来，与 <strong>系统当前其他活跃事务的 ID</strong> 去对比（由 Read View 维护），如果 <code>DB_TRX_ID</code> 跟 Read View 的属性做了某些比较，不符合可见性，那就通过 <code>DB_ROLL_PTR</code> 回滚指针去取出 Undo Log 中的 <code>DB_TRX_ID</code> 再比较，即<strong>遍历链表的 DB_TRX_ID（从链首到链尾，即从最近的一次修改查起），直到找到满足特定条件的 DB_TRX_ID ,</strong> 那么这个 DB_TRX_ID 所在的旧记录就是当前事务能看见的 <strong>最新老版本</strong></p><p><strong>那么这个判断条件是什么呢？</strong></p><p><img loading="lazy" src="/assets/images/20230415233529-82bbb45dc002dea7ffad7f33a564d862.png" width="720" height="632" class="img_ev3q"></p><p>如上，它是一段 MySQL 判断可见性的一段源码，即 changes_visible 方法（不完全哈，但能看出大致逻辑），该方法展示了我们拿 DB_TRX_ID 去跟 Read View 某些属性进行怎么样的比较</p><p>在展示之前，我先简化一下 Read View，我们可以把 Read View 简单的理解成有三个全局属性</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>三个全局属性</div><div class="admonitionContent_S0QG"><ul><li><code>trx_list</code>（名称我随意取的）<ul><li>一个数值列表</li><li>用于维护 Read View 生成时刻系统 正活跃的事务 ID 列表</li></ul></li><li><code>up_limit_id</code><ul><li>lower water remark</li><li>是 trx_list 列表中事务 ID 最小的 ID</li></ul></li><li><code>low_limit_id</code><ul><li>hight water mark</li><li>ReadView 生成时刻系统尚未分配的下一个事务 ID ，也就是 目前已出现过的事务 ID 的最大值 + 1</li><li>为什么是 low_limit ? 因为它也是系统此刻可分配的事务 ID 的最小值</li></ul></li></ul></div></div><ul><li>首先比较 <code>DB_TRX_ID &lt; up_limit_id</code> , 如果小于，则当前事务能看到 DB_TRX_ID 所在的记录，如果大于等于进入下一个判断</li><li>接下来判断 <code>DB_TRX_ID &gt;= low_limit_id</code> , 如果大于等于则代表 DB_TRX_ID 所在的记录在 Read View 生成后才出现的，那对当前事务肯定不可见，如果小于则进入下一个判断</li><li>判断 <code>DB_TRX_ID</code> 是否在活跃事务之中，<code>trx_list.contains (DB_TRX_ID)</code>，如果在，则代表我 Read View 生成时刻，你这个事务还在活跃，还没有 Commit，你修改的数据，我当前事务也是看不见的；如果不在，则说明，你这个事务在 Read View 生成之前就已经 Commit 了，你修改的结果，我当前事务是能看见的</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="整体流程">整体流程<a class="hash-link" href="#整体流程" title="标题的直接链接">​</a></h3><p>整体的流程是怎么样的呢？我们可以模拟一下</p><ul><li>当事务 2 对某行数据执行了快照读，数据库为该行数据生成一个Read View读视图，假设当前事务 ID 为 2，此时还有事务1和事务3在活跃中，事务 4 在事务 2 快照读前一刻提交更新了，所以 Read View 记录了系统当前活跃事务 1，3 的 ID，维护在一个列表上，假设我们称为 <code>trx_list</code></li></ul><p><img loading="lazy" src="data:image/png;base64,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" width="970" height="202" class="img_ev3q"></p><ul><li>Read View 不仅仅会通过一个列表 trx_list 来维护事务 2执行快照读那刻系统正活跃的事务 ID 列表，还会有两个属性 <code>up_limit_id</code>（ trx_list 列表中事务 ID 最小的 ID ），<code>low_limit_id</code> ( 快照读时刻系统尚未分配的下一个事务 ID ，也就是目前已出现过的事务ID的最大值 + 1 ) 。所以在这里例子中 <code>up_limit_id</code> 就是1，<code>low_limit_id</code> 就是 4 + 1 = 5，<code>trx_list</code> 集合的值是 1, 3，Read View 如下图</li></ul><p><img loading="lazy" src="data:image/png;base64,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" width="696" height="151" class="img_ev3q"></p><ul><li>我们的例子中，只有事务 4 修改过该行记录，并在事务 2 执行快照读前，就提交了事务，所以当前该行当前数据的 undo log 如下图所示；我们的事务 2 在快照读该行记录的时候，就会拿该行记录的 DB_TRX_ID 去跟 up_limit_id , low_limit_id 和活跃事务 ID 列表( trx_list )进行比较，判断当前事务 2能看到该记录的版本是哪个。</li></ul><p><img loading="lazy" src="/assets/images/20230416102650-14c189586afca9c6aa21fa92ed563b09.png" width="761" height="338" class="img_ev3q"></p><ul><li>所以先拿该记录 DB_TRX_ID 字段记录的事务 ID 4 去跟 Read View 的 up_limit_id 比较，看 4 是否小于 up_limit_id( 1 )，所以不符合条件，继续判断 4 是否大于等于 low_limit_id( 5 )，也不符合条件，最后判断 4 是否处于 trx_list 中的活跃事务, 最后发现事务 ID 为 4 的事务不在当前活跃事务列表中, 符合可见性条件，所以事务 4修改后提交的最新结果对事务 2 快照读时是可见的，所以事务 2 能读到的最新数据记录是事务4所提交的版本，而事务4提交的版本也是全局角度上最新的版本</li></ul><p><img loading="lazy" src="/assets/images/20230416102826-7d0ce5ad106afd1d15bcb36781ada626.png" width="1647" height="1141" class="img_ev3q"></p><ul><li>也正是 Read View 生成时机的不同，从而造成 RC , RR 级别下快照读的结果的不同</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mvcc-相关问题">MVCC 相关问题<a class="hash-link" href="#mvcc-相关问题" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rr-是如何在-rc-级的基础上解决不可重复读的">RR 是如何在 RC 级的基础上解决不可重复读的？<a class="hash-link" href="#rr-是如何在-rc-级的基础上解决不可重复读的" title="标题的直接链接">​</a></h3><p><strong>当前读和快照读在 RR 级别下的区别：</strong></p><p><code>表1:</code></p><p><img loading="lazy" src="/assets/images/20230416105409-90edf71e6aebb121f47df8bd7c83526d.png" width="965" height="278" class="img_ev3q"></p><p>在上表的顺序下，事务 B 的在事务 A 提交修改后的快照读是旧版本数据，而当前读是实时新数据 400</p><p><code>表2:</code></p><p><img loading="lazy" src="/assets/images/20230416105447-504deee35fe327a00fa017df92082d6f.png" width="965" height="364" class="img_ev3q"></p><p>这里与上表的唯一区别仅仅是 <code>表 1</code> 的事务 B 在事务 A 修改金额前 <code>快照读</code> 过一次金额数据，而 <code>表 2</code> 的事务B在事务A修改金额前没有进行过快照读。</p><p><strong>所以我们知道事务中快照读的结果是非常依赖该事务首次出现快照读的地方，即某个事务中首次出现快照读的地方非常关键，它有决定该事务后续快照读结果的能力</strong></p><p><strong>我们这里测试的是<code>更新</code>，同时<code>删除</code>和<code>更新</code>也是一样的，如果事务B的快照读是在事务A操作之后进行的，事务B的快照读也是能读取到最新的数据的</strong></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rc--rr-级别下的-innodb-快照读有什么不同">RC , RR 级别下的 InnoDB 快照读有什么不同？<a class="hash-link" href="#rc--rr-级别下的-innodb-快照读有什么不同" title="标题的直接链接">​</a></h3><p>正是 Read View 生成时机的不同，从而造成 RC , RR 级别下快照读的结果的不同</p><ul><li>在 RR 级别下的某个事务的对某条记录的第一次快照读会创建一个快照及 Read View, 将当前系统活跃的其他事务记录起来，此后在调用快照读的时候，还是使用的是同一个 Read View，所以只要当前事务在其他事务提交更新之前使用过快照读，那么之后的快照读使用的都是同一个 Read View，所以对之后的修改不可见；</li><li>即 RR 级别下，快照读生成 Read View 时，Read View 会记录此时所有其他活动事务的快照，这些事务的修改对于当前事务都是不可见的。而早于Read View创建的事务所做的修改均是可见</li><li>而在 RC 级别下的，事务中，每次快照读都会新生成一个快照和 Read View , 这就是我们在 RC 级别下的事务中可以看到别的事务提交的更新的原因</li></ul><p><strong>总之在 RC 隔离级别下，是每个快照读都会生成并获取最新的 Read View；而在 RR 隔离级别下，则是同一个事务中的第一个快照读才会创建 Read View, 之后的快照读获取的都是同一个 Read View。</strong></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="innodb-如何解决幻读问题">InnoDB 如何解决幻读问题<a class="hash-link" href="#innodb-如何解决幻读问题" title="标题的直接链接">​</a></h4><p><strong>MySQL InnoDB 引擎的默认隔离级别虽然是「可重复读」，但是它很大程度上避免幻读现象（并不是完全解决了）</strong>，解决的方案有两种：</p><ul><li>针对<strong>快照读</strong>（普通 select 语句），是<strong>通过 MVCC 方式解决了幻读</strong>，因为可重复读隔离级别下，事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，即使中途有其他事务插入了一条数据，是查询不出来这条数据的，所以就很好了避免幻读问题。</li><li>针对<strong>当前读</strong>（select ... for update 等语句），是<strong>通过 next-key lock（记录锁+间隙锁）方式解决了幻读</strong>，因为当执行 select ... for update 语句的时候，会加上 next-key lock，如果有其他事务在 next-key lock 锁范围内插入了一条记录，那么这个插入语句就会被阻塞，无法成功插入，所以就很好了避免幻读问题。</li></ul><hr><p>参考</p><ul><li>正确的理解MySQL的事务和隔离级别：<a href="https://blog.csdn.net/SnailMann/article/details/88299127" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/SnailMann/article/details/88299127</a></li><li>正确的理解MySQL的MVCC及实现原理：<a href="https://blog.csdn.net/SnailMann/article/details/94724197" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/SnailMann/article/details/94724197</a></li><li>事务隔离级别是怎么实现的：<a href="https://xiaolincoding.com/mysql/transaction/mvcc.html" target="_blank" rel="noopener noreferrer">https://xiaolincoding.com/mysql/transaction/mvcc.html</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/my-sql">MySQL</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>Hans</b> <!-- -->于 <b><time datetime="2023-04-15T14:58:00.000Z">2023年4月15日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/mysql/innodb-isolation"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">InnoDB 存储引擎的事务隔离特性</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/mysql/explain-cmd"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">EXPLAIN 命令详解</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-mvcc" class="table-of-contents__link toc-highlight">什么是 MVCC</a><ul><li><a href="#什么是-当前读-和-快照读" class="table-of-contents__link toc-highlight">什么是 当前读 和 快照读</a></li><li><a href="#当前读快照读和mvcc的关系" class="table-of-contents__link toc-highlight">当前读，快照读和MVCC的关系</a></li><li><a href="#mvcc-能解决什么问题好处是" class="table-of-contents__link toc-highlight">MVCC 能解决什么问题，好处是？</a></li></ul></li><li><a href="#mvcc-实现原理" class="table-of-contents__link toc-highlight">MVCC 实现原理</a><ul><li><a href="#隐式字段" class="table-of-contents__link toc-highlight">隐式字段</a></li><li><a href="#undo日志" class="table-of-contents__link toc-highlight">undo日志</a></li><li><a href="#read-view" class="table-of-contents__link toc-highlight">Read View</a></li><li><a href="#整体流程" class="table-of-contents__link toc-highlight">整体流程</a></li></ul></li><li><a href="#mvcc-相关问题" class="table-of-contents__link toc-highlight">MVCC 相关问题</a><ul><li><a href="#rr-是如何在-rc-级的基础上解决不可重复读的" class="table-of-contents__link toc-highlight">RR 是如何在 RC 级的基础上解决不可重复读的？</a></li><li><a href="#rc--rr-级别下的-innodb-快照读有什么不同" class="table-of-contents__link toc-highlight">RC , RR 级别下的 InnoDB 快照读有什么不同？</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Hans | <a href="https://beian.miit.gov.cn/">苏ICP备2021046511号</a> | Built with <a href="https://docusaurus.io/zh-CN/">Docusaurus</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.a5c98095.js"></script>
<script src="/assets/js/main.e7217a4b.js"></script>
</body>
</html>