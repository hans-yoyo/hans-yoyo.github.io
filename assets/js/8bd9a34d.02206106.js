"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8088],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>f});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),g=p(t),f=r,d=g["".concat(l,".").concat(f)]||g[f]||u[f]||o;return t?a.createElement(d,s(s({ref:n},c),{},{components:t})):a.createElement(d,s({ref:n},c))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=g;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var p=2;p<o;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},1163:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var a=t(7462),r=(t(7294),t(3905));const o={title:"Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa",slug:"aop-implement",sidebar_position:6,keywords:["Spring"],tags:["Spring"],draft:!1,hide_table_of_contents:!1,last_update:{date:"2023-05-26 22:26",author:"Hans"}},s=void 0,i={unversionedId:"spring/Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa",id:"spring/Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa",title:"Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa",description:"AOP \u5207\u9762\u5b9e\u73b0",source:"@site/docs/04.spring/06.Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa.md",sourceDirName:"04.spring",slug:"/spring/aop-implement",permalink:"/docs/spring/aop-implement",draft:!1,tags:[{label:"Spring",permalink:"/docs/tags/spring"}],version:"current",lastUpdatedBy:"Hans",lastUpdatedAt:1685111160,formattedLastUpdatedAt:"2023\u5e745\u670826\u65e5",sidebarPosition:6,frontMatter:{title:"Spring\u6838\u5fc3-AOP\u5207\u9762\u5b9e\u73b0\u53ca\u4ee3\u7406\u521b\u5efa",slug:"aop-implement",sidebar_position:6,keywords:["Spring"],tags:["Spring"],draft:!1,hide_table_of_contents:!1,last_update:{date:"2023-05-26 22:26",author:"Hans"}},sidebar:"tutorialSidebar",previous:{title:"Spring\u6838\u5fc3-AOP\u7406\u89e3\u53ca\u4f7f\u7528",permalink:"/docs/spring/aop-basic"},next:{title:"\u6846\u67b6\u548c\u4e2d\u95f4\u4ef6",permalink:"/docs/category/\u6846\u67b6\u548c\u4e2d\u95f4\u4ef6"}},l={},p=[{value:"AOP \u5207\u9762\u5b9e\u73b0",id:"aop-\u5207\u9762\u5b9e\u73b0",level:2},{value:"XML \u6807\u7b7e\u7684\u89e3\u6790",id:"xml-\u6807\u7b7e\u7684\u89e3\u6790",level:3},{value:"config\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790",id:"config\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790",level:4},{value:"aspectj-autoproxy \u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790",id:"aspectj-autoproxy-\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790",level:4},{value:"\u6ce8\u89e3\u5207\u9762\u4ee3\u7406\u521b\u5efa\u7c7b(AnnotationAwareAspectJAutoProxyCreator)",id:"\u6ce8\u89e3\u5207\u9762\u4ee3\u7406\u521b\u5efa\u7c7bannotationawareaspectjautoproxycreator",level:3},{value:"postProcessBeforeInstantiation",id:"postprocessbeforeinstantiation",level:4},{value:"postProcessAfterInitialization",id:"postprocessafterinitialization",level:4},{value:"AOP \u5207\u9762\u5b9e\u73b0 \u603b\u7ed3",id:"aop-\u5207\u9762\u5b9e\u73b0-\u603b\u7ed3",level:3},{value:"AOP \u4ee3\u7406\u7684\u521b\u5efa",id:"aop-\u4ee3\u7406\u7684\u521b\u5efa",level:2}],c={toc:p};function u(e){let{components:n,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"aop-\u5207\u9762\u5b9e\u73b0"},"AOP \u5207\u9762\u5b9e\u73b0"),(0,r.kt)("p",null,"Spring AOP\u539f\u7406\u89e3\u6790\u7684\u5207\u9762\u5b9e\u73b0\u8fc7\u7a0b\uff1a\u52a0\u8f7d\u914d\u7f6e\uff0c\u5c06\u5207\u9762\u7c7b\u7684\u6240\u6709\u5207\u9762\u65b9\u6cd5\u6839\u636e\u4f7f\u7528\u7684\u6ce8\u89e3\u751f\u6210\u5bf9\u5e94Advice\uff0c\u5e76\u5c06Advice\u8fde\u540c\u5207\u5165\u70b9\u5339\u914d\u5668\u548c\u5207\u9762\u7c7b\u7b49\u4fe1\u606f\u4e00\u5e76\u5c01\u88c5\u5230Advisor)\u3002"),(0,r.kt)("h3",{id:"xml-\u6807\u7b7e\u7684\u89e3\u6790"},"XML \u6807\u7b7e\u7684\u89e3\u6790"),(0,r.kt)("p",null,"\u6ce8\u518cBeanDefinition\u7684\u89e3\u6790\u5668BeanDefinitionParser\uff0c\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"aop:xxxxxx"),"\u914d\u7f6e\u6807\u7b7e\u4ea4\u7ed9\u6307\u5b9a\u7684parser\u6765\u5904\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class AopNamespaceHandler extends NamespaceHandlerSupport {\n\n    /**\n     * Register the {@link BeanDefinitionParser BeanDefinitionParsers} for the\n     * '{@code config}', '{@code spring-configured}', '{@code aspectj-autoproxy}'\n     * and '{@code scoped-proxy}' tags.\n     */\n    @Override\n    public void init() {\n        // In 2.0 XSD as well as in 2.5+ XSDs\n        registerBeanDefinitionParser(\"config\", new ConfigBeanDefinitionParser());\n        registerBeanDefinitionParser(\"aspectj-autoproxy\", new AspectJAutoProxyBeanDefinitionParser());\n        registerBeanDefinitionDecorator(\"scoped-proxy\", new ScopedProxyBeanDefinitionDecorator());\n\n        // Only in 2.0 XSD: moved to context namespace in 2.5+\n        registerBeanDefinitionParser(\"spring-configured\", new SpringConfiguredBeanDefinitionParser());\n    }\n\n}\n")),(0,r.kt)("h4",{id:"config\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790"},"config\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"<aop:config/>")," \u7531ConfigBeanDefinitionParser\u8fd9\u4e2a\u7c7b\u5904\u7406\uff0c\u4f5c\u4e3aparser\u7c7b\u6700\u91cd\u8981\u7684\u5c31\u662fparse\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"// org.springframework.aop.config.ConfigBeanDefinitionParser#parse\n\n@Override\n@Nullable\npublic BeanDefinition parse(Element element, ParserContext parserContext) {\n    CompositeComponentDefinition compositeDef =\n            new CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));\n    parserContext.pushContainingComponent(compositeDef);\n\n    configureAutoProxyCreator(parserContext, element);\n\n    List<Element> childElts = DomUtils.getChildElements(element);\n    for (Element elt: childElts) {\n        String localName = parserContext.getDelegate().getLocalName(elt);\n        if (POINTCUT.equals(localName)) {\n            parsePointcut(elt, parserContext);\n        }\n        else if (ADVISOR.equals(localName)) {\n            parseAdvisor(elt, parserContext);\n        }\n        else if (ASPECT.equals(localName)) {\n            parseAspect(elt, parserContext);\n        }\n    }\n\n    parserContext.popAndRegisterContainingComponent();\n    return null;\n}\n\n")),(0,r.kt)("h4",{id:"aspectj-autoproxy-\u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790"},"aspectj-autoproxy \u914d\u7f6e\u6807\u7b7e\u7684\u89e3\u6790"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"<aop:aspectj-autoproxy/>")," \u5219\u7531AspectJAutoProxyBeanDefinitionParser\u8fd9\u4e2a\u7c7b\u5904\u7406\u7684\uff0c\u6211\u4eec\u770b\u4e0bparse \u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"\n@Override\n@Nullable\npublic BeanDefinition parse(Element element, ParserContext parserContext) {\n    // \u6ce8\u518cAspectJAnnotationAutoProxyCreator\n    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);\n    // \u62d3\u5c55BeanDefinition\n    extendBeanDefinition(element, parserContext);\n    return null;\n}\n\n// AopNamespaceUtils#registerAspectJAnnotationAutoProxyCreatorIfNecessary\n\npublic static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(\n        ParserContext parserContext, Element sourceElement) {\n\n    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(\n            parserContext.getRegistry(), parserContext.extractSource(sourceElement));\n    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);\n    registerComponentIfNecessary(beanDefinition, parserContext);\n}\n\n\n// AopConfigUtils#registerAspectJAnnotationAutoProxyCreatorIfNecessary\n\n@Nullable\npublic static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary(\n        BeanDefinitionRegistry registry, @Nullable Object source) {\n    // \u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u53d1\u73b0AOP\u7684\u521b\u5efa\u5de5\u4f5c\u662f\u4ea4\u7ed9AnnotationAwareAspectJAutoProxyCreator\u6765\u5b8c\u6210\u7684\n    return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);\n}\n")),(0,r.kt)("h3",{id:"\u6ce8\u89e3\u5207\u9762\u4ee3\u7406\u521b\u5efa\u7c7bannotationawareaspectjautoproxycreator"},"\u6ce8\u89e3\u5207\u9762\u4ee3\u7406\u521b\u5efa\u7c7b(AnnotationAwareAspectJAutoProxyCreator)"),(0,r.kt)("p",null,"\u7c7b\u7ed3\u6784\u5173\u7cfb"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(8056).Z,width:"2928",height:"1498"})),(0,r.kt)("p",null,"\u5b83\u5b9e\u73b0\u4e86\u4e24\u7c7b\u63a5\u53e3\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"BeanFactoryAware\u5c5e\u4e8e",(0,r.kt)("strong",{parentName:"li"},"Bean\u7ea7\u751f\u547d\u5468\u671f\u63a5\u53e3\u65b9\u6cd5")),(0,r.kt)("li",{parentName:"ul"},"InstantiationAwareBeanPostProcessor \u548c BeanPostProcessor \u8fd9\u4e24\u4e2a\u63a5\u53e3\u5b9e\u73b0\uff0c\u4e00\u822c\u79f0\u5b83\u4eec\u7684\u5b9e\u73b0\u7c7b\u4e3a\u201c\u540e\u5904\u7406\u5668\u201d\uff0c\u662f",(0,r.kt)("strong",{parentName:"li"},"\u5bb9\u5668\u7ea7\u751f\u547d\u5468\u671f\u63a5\u53e3\u65b9\u6cd5"),"\uff1b")),(0,r.kt)("p",null,"\u6211\u4eec\u5c31\u53ef\u4ee5\u5b9a\u4f4d\u5230\u6838\u5fc3\u7684\u521d\u59cb\u5316\u65b9\u6cd5\u80af\u5b9a\u5728 postProcessBeforeInstantiation \u548c postProcessAfterInitialization\u4e2d\u3002"),(0,r.kt)("h4",{id:"postprocessbeforeinstantiation"},"postProcessBeforeInstantiation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"// AbstractAutoProxyCreator#postProcessBeforeInstantiation\n\n@Override\npublic Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) {\n    Object cacheKey = getCacheKey(beanClass, beanName);\n\n    if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) {\n        if (this.advisedBeans.containsKey(cacheKey)) {\n            return null;\n        }\n        // \u662f\u5426\u662faop\u57fa\u7840\u7c7b\uff1f\u662f\u5426\u8df3\u8fc7\uff1f\n        if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) {\n            this.advisedBeans.put(cacheKey, Boolean.FALSE);\n            return null;\n        }\n    }\n\n    // Create proxy here if we have a custom TargetSource.\n    // Suppresses unnecessary default instantiation of the target bean:\n    // The TargetSource will handle target instances in a custom fashion.\n    TargetSource targetSource = getCustomTargetSource(beanClass, beanName);\n    if (targetSource != null) {\n        if (StringUtils.hasLength(beanName)) {\n            this.targetSourcedBeans.add(beanName);\n        }\n        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);\n        Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);\n        this.proxyTypes.put(cacheKey, proxy.getClass());\n        return proxy;\n    }\n\n    return null;\n}\n\n")),(0,r.kt)("h4",{id:"postprocessafterinitialization"},"postProcessAfterInitialization"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"// AbstractAutoProxyCreator#postProcessAfterInitialization\n\n@Override\npublic Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\n    if (bean != null) {\n        Object cacheKey = getCacheKey(bean.getClass(), beanName);\n        if (this.earlyProxyReferences.remove(cacheKey) != bean) {\n            return wrapIfNecessary(bean, beanName, cacheKey);\n        }\n    }\n    return bean;\n}\n")),(0,r.kt)("h3",{id:"aop-\u5207\u9762\u5b9e\u73b0-\u603b\u7ed3"},"AOP \u5207\u9762\u5b9e\u73b0 \u603b\u7ed3"),(0,r.kt)("p",null,"\u901a\u8fc7\u4e0a\u6587\u7684\u5206\u6790\uff0c\u6211\u4eec\u505a\u4e0b\u5c0f\u7ed3\uff1a"),(0,r.kt)("p",null,"1\u3001\u7531",(0,r.kt)("strong",{parentName:"p"},"IOC Bean\u52a0\u8f7d"),"\u65b9\u6cd5\u6808\u4e2d\u627e\u5230parseCustomElement\u65b9\u6cd5\uff0c\u627e\u5230parse ",(0,r.kt)("inlineCode",{parentName:"p"},"aop:aspectj-autoproxy"),"\u7684handler(org.springframework.aop.config.AopNamespaceHandler)"),(0,r.kt)("p",null,"2\u3001",(0,r.kt)("strong",{parentName:"p"},"AopNamespaceHandler"),"\u6ce8\u518c\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"<aop:aspectj-autoproxy/>"),"\u7684\u89e3\u6790\u7c7b\u662fAspectJAutoProxyBeanDefinitionParser"),(0,r.kt)("p",null,"3\u3001",(0,r.kt)("strong",{parentName:"p"},"AspectJAutoProxyBeanDefinitionParser"),"\u7684parse \u65b9\u6cd5 \u901a\u8fc7AspectJAwareAdvisorAutoProxyCreator\u7c7b\u53bb\u521b\u5efa"),(0,r.kt)("p",null,"4\u3001 ",(0,r.kt)("strong",{parentName:"p"},"AspectJAwareAdvisorAutoProxyCreator"),"\u5b9e\u73b0\u4e86\u4e24\u7c7b\u63a5\u53e3\uff0cBeanFactoryAware\u548cBeanPostProcessor\uff1b\u6839\u636eBean\u751f\u547d\u5468\u671f\u65b9\u6cd5\u627e\u5230\u4e24\u4e2a\u6838\u5fc3\u65b9\u6cd5\uff1apostProcessBeforeInstantiation\u548cpostProcessAfterInitialization"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"1. **postProcessBeforeInstantiation**\uff1a\u4e3b\u8981\u662f\u5904\u7406\u4f7f\u7528\u4e86@Aspect\u6ce8\u89e3\u7684\u5207\u9762\u7c7b\uff0c\u7136\u540e\u5c06\u5207\u9762\u7c7b\u7684\u6240\u6709\u5207\u9762\u65b9\u6cd5\u6839\u636e\u4f7f\u7528\u7684\u6ce8\u89e3\u751f\u6210\u5bf9\u5e94Advice\uff0c\u5e76\u5c06Advice\u8fde\u540c\u5207\u5165\u70b9\u5339\u914d\u5668\u548c\u5207\u9762\u7c7b\u7b49\u4fe1\u606f\u4e00\u5e76\u5c01\u88c5\u5230Advisor\n2. **postProcessAfterInitialization**\uff1a\u4e3b\u8981\u8d1f\u8d23\u5c06Advisor\u6ce8\u5165\u5230\u5408\u9002\u7684\u4f4d\u7f6e\uff0c\u521b\u5efa\u4ee3\u7406\uff08cglib\u6216jdk)\uff0c\u4e3a\u540e\u9762\u7ed9\u4ee3\u7406\u8fdb\u884c\u589e\u5f3a\u5b9e\u73b0\u505a\u51c6\u5907\u3002\n")),(0,r.kt)("h2",{id:"aop-\u4ee3\u7406\u7684\u521b\u5efa"},"AOP \u4ee3\u7406\u7684\u521b\u5efa"),(0,r.kt)("p",null,"AOP \u7684\u4ee3\u7406\u521b\u5efa\u8fc7\u7a0b\uff0c\u521b\u5efa\u4ee3\u7406\u7684\u65b9\u6cd5\u662f\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractAutoProxyCreator#postProcessAfterInitialization")," \u4e2d"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"// AbstractAutoProxyCreator#postProcessAfterInitialization\n\n@Override\npublic Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\n    if (bean != null) {\n        Object cacheKey = getCacheKey(bean.getClass(), beanName);\n        if (this.earlyProxyReferences.remove(cacheKey) != bean) {\n            return wrapIfNecessary(bean, beanName, cacheKey);\n        }\n    }\n    return bean;\n}\n")),(0,r.kt)("p",null,"wrapIfNecessary\u65b9\u6cd5\u4e3b\u8981\u7528\u4e8e\u5224\u65ad\u662f\u5426\u9700\u8981\u521b\u5efa\u4ee3\u7406\uff0c\u5982\u679cBean\u80fd\u591f\u83b7\u53d6\u5230advisor\u624d\u9700\u8981\u521b\u5efa\u4ee3\u7406"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"// AbstractAutoProxyCreator#wrapIfNecessary\nprotected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {\n    if (StringUtils.hasLength(beanName) && this.targetSourcedBeans.contains(beanName)) {\n        return bean;\n    }\n    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) {\n        return bean;\n    }\n    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {\n        this.advisedBeans.put(cacheKey, Boolean.FALSE);\n        return bean;\n    }\n\n    // Create proxy if we have advice.\n    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);\n    if (specificInterceptors != DO_NOT_PROXY) {\n        this.advisedBeans.put(cacheKey, Boolean.TRUE);\n        // \u91cd\u70b9\n        Object proxy = createProxy(\n                bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));\n        this.proxyTypes.put(cacheKey, proxy.getClass());\n        return proxy;\n    }\n\n    this.advisedBeans.put(cacheKey, Boolean.FALSE);\n    return bean;\n}\n\n")),(0,r.kt)("p",null,"\u83b7\u53d6\u6240\u6709advisor\u540e\uff0c\u5982\u679c\u6709advisor\uff0c\u5219\u8bf4\u660e\u9700\u8981\u589e\u5f3a\uff0c\u5373\u9700\u8981\u521b\u5efa\u4ee3\u7406\uff0c\u521b\u5efa\u4ee3\u7406\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"\nprotected Object createProxy(Class<?> beanClass, @Nullable String beanName,\n            @Nullable Object[] specificInterceptors, TargetSource targetSource) {\n\n    if (this.beanFactory instanceof ConfigurableListableBeanFactory) {\n        AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass);\n    }\n\n    ProxyFactory proxyFactory = new ProxyFactory();\n    proxyFactory.copyFrom(this);\n\n    if (proxyFactory.isProxyTargetClass()) {\n        // Explicit handling of JDK proxy targets (for introduction advice scenarios)\n        if (Proxy.isProxyClass(beanClass)) {\n            // Must allow for introductions; can't just set interfaces to the proxy's interfaces only.\n            for (Class<?> ifc : beanClass.getInterfaces()) {\n                proxyFactory.addInterface(ifc);\n            }\n        }\n    }\n    else {\n        // No proxyTargetClass flag enforced, let's apply our default checks...\n        if (shouldProxyTargetClass(beanClass, beanName)) {\n            proxyFactory.setProxyTargetClass(true);\n        }\n        else {\n            evaluateProxyInterfaces(beanClass, proxyFactory);\n        }\n    }\n\n    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);\n    proxyFactory.addAdvisors(advisors);\n    proxyFactory.setTargetSource(targetSource);\n    customizeProxyFactory(proxyFactory);\n\n    proxyFactory.setFrozen(this.freezeProxy);\n    if (advisorsPreFiltered()) {\n        proxyFactory.setPreFiltered(true);\n    }\n\n    // Use original ClassLoader if bean class not locally loaded in overriding class loader\n    ClassLoader classLoader = getProxyClassLoader();\n    if (classLoader instanceof SmartClassLoader && classLoader != beanClass.getClassLoader()) {\n        classLoader = ((SmartClassLoader) classLoader).getOriginalClassLoader();\n    }\n    // \n    return proxyFactory.getProxy(classLoader);\n}\n")),(0,r.kt)("p",null,"\u7531 DefaultAopProxyFactory \u5de5\u5382\u7c7b\u521b\u5efa\u4ee3\u7406\u7c7b (jdk\u6216cglib)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'\n// org.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy\n@Override\npublic AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {\n    if (!NativeDetector.inNativeImage() &&\n            (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config))) {\n        Class<?> targetClass = config.getTargetClass();\n        if (targetClass == null) {\n            throw new AopConfigException("TargetSource cannot determine target class: " +\n                    "Either an interface or a target is required for proxy creation.");\n        }\n        if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {\n            return new JdkDynamicAopProxy(config);\n        }\n        return new ObjenesisCglibAopProxy(config);\n    }\n    else {\n        return new JdkDynamicAopProxy(config);\n    }\n}\n\n')),(0,r.kt)("p",null,"\u51e0\u4e2a\u8981\u70b9"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"config.isOptimize() \u662f\u901a\u8fc7optimize\u8bbe\u7f6e\uff0c\u8868\u793a\u914d\u7f6e\u662f\u81ea\u5b9a\u4e49\u7684\uff0c\u9ed8\u8ba4\u662ffalse\uff1b"),(0,r.kt)("li",{parentName:"ul"},"config.isProxyTargetClass()\u662f\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"li"},'<aop:config proxy-target-class="true" />')," \u6765\u914d\u7f6e\u7684\uff0c\u8868\u793a\u4f18\u5148\u4f7f\u7528cglib\u4ee3\u7406\uff0c\u9ed8\u8ba4\u662ffalse\uff1b"),(0,r.kt)("li",{parentName:"ul"},"hasNoUserSuppliedProxyInterfaces(config) \u8868\u793a\u662f\u5426\u76ee\u6807\u7c7b\u5b9e\u73b0\u4e86\u63a5\u53e3")),(0,r.kt)("p",null,"\u7531\u6b64\u53ef\u77e5\u9053\uff1a"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Spring\u9ed8\u8ba4\u5728\u76ee\u6807\u7c7b\u5b9e\u73b0\u63a5\u53e3\u65f6\u662f\u901a\u8fc7JDK\u4ee3\u7406\u5b9e\u73b0\u7684\uff0c\u53ea\u6709\u975e\u63a5\u53e3\u7684\u662f\u901a\u8fc7Cglib\u4ee3\u7406\u5b9e\u73b0\u7684\u3002\u5f53\u8bbe\u7f6eproxy-target-class\u4e3atrue\u65f6\u5728\u76ee\u6807\u7c7b\u4e0d\u662f\u63a5\u53e3\u6216\u8005\u4ee3\u7406\u7c7b\u65f6\u4f18\u5148\u4f7f\u7528cglib\u4ee3\u7406\u5b9e\u73b0\u3002")),(0,r.kt)("hr",null),(0,r.kt)("p",null,"\u53c2\u8003\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Spring AOP\u5b9e\u73b0\u539f\u7406\u8be6\u89e3\u4e4bAOP\u5207\u9762\u7684\u5b9e\u73b0\uff1a",(0,r.kt)("a",{parentName:"li",href:"https://www.pdai.tech/md/spring/spring-x-framework-aop-source-1.html"},"https://www.pdai.tech/md/spring/spring-x-framework-aop-source-1.html")),(0,r.kt)("li",{parentName:"ul"},"Spring AOP\u5b9e\u73b0\u539f\u7406\u8be6\u89e3\u4e4bAOP\u4ee3\u7406\u7684\u521b\u5efa\uff1a",(0,r.kt)("a",{parentName:"li",href:"https://www.pdai.tech/md/spring/spring-x-framework-aop-source-2.html"},"https://www.pdai.tech/md/spring/spring-x-framework-aop-source-2.html"))))}u.isMDXComponent=!0},8056:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/20230526225113-6138d35591f420cd6e8fd3f82c158f82.png"}}]);